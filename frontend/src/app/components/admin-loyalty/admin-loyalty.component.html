<div class="admin-loyalty-container">
  <div class="page-header">
    <h1>ğŸ† Loyalty Management</h1>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button
      class="tab"
      [class.active]="activeTab === 'rewards'"
      (click)="switchTab('rewards')">
      ğŸ Rewards
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'accounts'"
      (click)="switchTab('accounts')">
      ğŸ‘¥ Accounts
    </button>
    <button
      class="tab"
      [class.active]="activeTab === 'redemptions'"
      (click)="switchTab('redemptions')">
      ğŸ“œ Redemptions
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-spinner">
    <div class="spinner"></div>
    <p>Loading...</p>
  </div>

  <!-- Rewards Tab -->
  <div *ngIf="!loading && activeTab === 'rewards'" class="tab-content">
    <div class="section-header">
      <h2>Reward Items</h2>
      <button class="btn-create" (click)="openCreateModal()">
        â• Add Reward
      </button>
    </div>

    <div class="rewards-grid">
      <div *ngFor="let reward of rewards" class="reward-card">
        <div class="reward-icon">{{ reward.icon }}</div>
        <div class="reward-status">
          <button
            class="status-toggle"
            [class.active]="reward.isActive"
            (click)="toggleRewardActive(reward)">
            {{ reward.isActive ? 'âœ“ Active' : 'âœ— Inactive' }}
          </button>
        </div>
        <h3>{{ reward.name }}</h3>
        <p class="reward-description">{{ reward.description }}</p>
        <div class="reward-cost">
          <span class="points">{{ reward.pointsCost }}</span>
          <span class="label">points</span>
        </div>
        <div *ngIf="reward.expiresAt" class="reward-expiry">
          Expires: {{ formatDate(reward.expiresAt) }}
        </div>
        <div class="reward-actions">
          <button class="btn-edit" (click)="openEditModal(reward)">âœï¸ Edit</button>
          <button class="btn-delete" (click)="deleteReward(reward.id!)">ğŸ—‘ï¸ Delete</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Accounts Tab -->
  <div *ngIf="!loading && activeTab === 'accounts'" class="tab-content">
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-icon">ğŸ‘¥</div>
        <div class="stat-value">{{ getAccountStats().total }}</div>
        <div class="stat-label">Total Members</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">â­</div>
        <div class="stat-value">{{ getAccountStats().totalPoints }}</div>
        <div class="stat-label">Active Points</div>
      </div>
      <div class="stat-card" *ngFor="let tier of tierConfig">
        <div class="stat-icon" [style.color]="tier.color">ğŸ†</div>
        <div class="stat-value">{{ getAccountStats().byTier[tier.name] || 0 }}</div>
        <div class="stat-label">{{ tier.name }}</div>
      </div>
    </div>

    <div class="tier-config-section">
      <h2>Tier Configuration</h2>
      <div class="tier-grid">
        <div *ngFor="let tier of tierConfig" class="tier-card" [style.border-color]="tier.color">
          <div class="tier-header" [style.background]="tier.color">
            <span class="tier-name">{{ tier.name }}</span>
          </div>
          <div class="tier-details">
            <p><strong>Min Points:</strong> {{ tier.minPoints }}</p>
            <p><strong>Benefits:</strong> {{ tier.benefits }}</p>
          </div>
        </div>
      </div>
    </div>

    <div class="accounts-table">
      <h2>Member Accounts</h2>
      <table>
        <thead>
          <tr>
            <th>Username</th>
            <th>Tier</th>
            <th>Current Points</th>
            <th>Total Earned</th>
            <th>Total Redeemed</th>
            <th>Member Since</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let account of loyaltyAccounts">
            <td>{{ account.username }}</td>
            <td>
              <span class="tier-badge" [ngClass]="getTierBadgeClass(account.tier)">
                {{ account.tier }}
              </span>
            </td>
            <td class="points-cell">{{ account.currentPoints }}</td>
            <td>{{ account.totalPointsEarned }}</td>
            <td>{{ account.totalPointsRedeemed }}</td>
            <td>{{ formatDate(account.createdAt) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Redemptions Tab -->
  <div *ngIf="!loading && activeTab === 'redemptions'" class="tab-content">
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“œ</div>
        <div class="stat-value">{{ getRedemptionStats().total }}</div>
        <div class="stat-label">Total Redemptions</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ’</div>
        <div class="stat-value">{{ getRedemptionStats().totalPoints }}</div>
        <div class="stat-label">Points Redeemed</div>
      </div>
    </div>

    <div class="redemptions-table">
      <h2>Redemption History</h2>
      <table>
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>User ID</th>
            <th>Description</th>
            <th>Points</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let redemption of redemptions">
            <td>{{ formatDateTime(redemption.createdAt) }}</td>
            <td class="user-id">{{ redemption.userId }}</td>
            <td>{{ redemption.description }}</td>
            <td class="points-cell redemption">{{ getAbsolutePoints(redemption.points) }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Reward Modal -->
<div class="modal-overlay" *ngIf="showRewardModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditMode ? 'Edit Reward' : 'Create New Reward' }}</h2>
      <button class="btn-close" (click)="closeModal()">âœ•</button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="saveReward()">
        <div class="form-row">
          <div class="form-group">
            <label>Icon</label>
            <input type="text" [(ngModel)]="rewardForm.icon" name="icon" required maxlength="2">
          </div>
          <div class="form-group flex-2">
            <label>Name *</label>
            <input type="text" [(ngModel)]="rewardForm.name" name="name" required>
          </div>
        </div>

        <div class="form-group">
          <label>Description *</label>
          <textarea [(ngModel)]="rewardForm.description" name="description" rows="3" required></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Points Cost *</label>
            <input type="number" [(ngModel)]="rewardForm.pointsCost" name="pointsCost" required min="1">
          </div>
          <div class="form-group">
            <label>Expires At (Optional)</label>
            <input type="datetime-local" [(ngModel)]="rewardForm.expiresAt" name="expiresAt">
          </div>
        </div>

        <div class="form-group checkbox-group">
          <label>
            <input type="checkbox" [(ngModel)]="rewardForm.isActive" name="isActive">
            <span>Active</span>
          </label>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" (click)="closeModal()">
            Cancel
          </button>
          <button type="submit" class="btn-save">
            {{ isEditMode ? 'Update' : 'Create' }} Reward
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
