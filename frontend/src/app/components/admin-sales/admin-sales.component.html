<div class="admin-sales-container">
  <div class="page-header">
    <h1>üìä Sales Management</h1>
    <div class="header-actions">
      <button class="btn-primary" (click)="openAddModal()">‚ûï Add Sales</button>
      <button class="btn-secondary" (click)="openUploadModal()">üì§ Upload Excel</button>
      <button class="btn-info" (click)="loadSummary()">üìà View Summary</button>
      <button class="btn-secondary" (click)="initializeSalesItemTypes()" *ngIf="salesItemTypes.length === 0">üîß Initialize Items</button>
    </div>
  </div>

  <!-- Summary Section -->
  <div *ngIf="summary" class="summary-card">
    <h2>Sales Summary - {{ formatDate(summary.date) }}</h2>
    <div class="summary-grid">
      <div class="summary-item">
        <span class="label">Total Sales:</span>
        <span class="value">{{ formatCurrency(summary.totalSales) }}</span>
      </div>
      <div class="summary-item">
        <span class="label">Total Transactions:</span>
        <span class="value">{{ summary.totalTransactions }}</span>
      </div>
    </div>
    <div class="payment-breakdown">
      <h3>Payment Method Breakdown</h3>
      <div *ngFor="let method of summary.paymentMethodBreakdown | keyvalue" class="breakdown-item">
        <span>{{ method.key }}:</span>
        <span>{{ formatCurrency(+(method.value || 0)) }}</span>
      </div>
    </div>
    <div class="summary-date-picker">
      <label>Summary Date:</label>
      <input type="date" [(ngModel)]="summaryDate" (change)="loadSummary()">
    </div>
  </div>

  <!-- Sales List -->
  <div class="sales-list">
    <div *ngIf="loading" class="loading">Loading...</div>

    <div *ngIf="!loading && sales.length === 0" class="empty-state">
      <p>No sales records found</p>
    </div>

    <!-- Year-Month Grouped View -->
    <div *ngIf="!loading && sales.length > 0" class="grouped-sales">
      <div *ngFor="let year of getYears()" class="year-group">
        <!-- Year Header -->
        <div class="year-header" (click)="toggleYear(year)">
          <div class="year-title">
            <span class="expand-icon">{{ isYearExpanded(year) ? '‚ñº' : '‚ñ∂' }}</span>
            <strong>üìÖ {{ year }}</strong>
            <span class="year-stats">{{ getMonths(year).length }} months</span>
          </div>
          <div class="year-total">
            {{ formatCurrency(getYearTotal(year)) }}
          </div>
        </div>

        <!-- Months Container -->
        <div *ngIf="isYearExpanded(year)" class="months-container">
          <div *ngFor="let month of getMonths(year)" class="month-group">
            <!-- Month Header -->
            <div class="month-header" (click)="toggleMonth(year, month)">
              <div class="month-title">
                <span class="expand-icon">{{ isMonthExpanded(year, month) ? '‚ñº' : '‚ñ∂' }}</span>
                <strong>{{ month }}</strong>
                <span class="month-stats">{{ getWeeks(year, month).length }} weeks</span>
              </div>
              <div class="month-total">
                {{ formatCurrency(getMonthTotal(year, month)) }}
              </div>
            </div>

            <!-- Weeks Container -->
            <div *ngIf="isMonthExpanded(year, month)" class="weeks-container">
              <div *ngFor="let week of getWeeks(year, month)" class="week-group">
                <!-- Week Header -->
                <div class="week-header" (click)="toggleWeek(year, month, week)">
                  <div class="week-title">
                    <span class="expand-icon">{{ isWeekExpanded(year, month, week) ? '‚ñº' : '‚ñ∂' }}</span>
                    <strong>{{ week }}</strong>
                    <span class="week-stats">{{ groupedSales[year][month][week].length }} records</span>
                  </div>
                  <div class="week-total">
                    {{ formatCurrency(getWeekTotal(year, month, week)) }}
                  </div>
                </div>

                <!-- Sales Cards -->
                <div *ngIf="isWeekExpanded(year, month, week)" class="sales-cards">
                  <div *ngFor="let sale of groupedSales[year][month][week]" class="sales-card">
                    <div class="sales-header">
                      <div class="sales-date">
                        <strong>üìÖ {{ formatDate(sale.date) }}</strong>
                      </div>
                      <div class="sales-amount">
                        {{ formatCurrency(sale.totalAmount) }}
                      </div>
                    </div>

                    <div class="sales-items">
                      <div *ngFor="let item of sale.items" class="item-row">
                        <span class="item-name">{{ item.itemName }}</span>
                        <span class="item-qty">√ó {{ item.quantity }}</span>
                        <span class="item-price">{{ formatCurrency(item.totalPrice) }}</span>
                      </div>
                    </div>

                    <div class="sales-footer">
                      <div class="sales-meta">
                        <span class="payment-method">üí≥ {{ sale.paymentMethod }}</span>
                        <span class="recorded-by">üë§ {{ sale.recordedBy }}</span>
                      </div>
                      <div class="sales-actions">
                        <button class="btn-edit" (click)="openEditModal(sale)">‚úèÔ∏è Edit</button>
                        <button class="btn-delete" (click)="deleteSales(sale.id)">üóëÔ∏è Delete</button>
                      </div>
                    </div>

                    <div *ngIf="sale.notes" class="sales-notes">
                      <em>Note: {{ sale.notes }}</em>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingId ? 'Edit' : 'Add' }} Sales Record</h2>
        <button class="btn-close" (click)="closeModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Date *</label>
          <input type="date" [(ngModel)]="formData.date" required>
        </div>

        <div class="form-group">
          <label>Payment Method *</label>
          <select [(ngModel)]="formData.paymentMethod" required>
            <option *ngFor="let method of paymentMethods" [value]="method">{{ method }}</option>
          </select>
        </div>

        <!-- Sales Items Section -->
        <div class="add-item-section">
          <h3>Sales Items (Edit quantities or delete unwanted items)</h3>

          <!-- Items List -->
          <div *ngIf="formData.items.length > 0" class="items-list">
            <div *ngFor="let item of formData.items; let i = index" class="item-card editable">
              <div class="item-info">
                <strong>{{ item.itemName }}</strong>
              </div>
              <div class="item-controls">
                <div class="quantity-control">
                  <label>Qty:</label>
                  <input type="number" [(ngModel)]="item.quantity" min="0" class="qty-input"
                         [readonly]="!isTeaVariant(item.itemName)">
                </div>
                <div class="price-control">
                  <label>Price:</label>
                  <input type="number" [(ngModel)]="item.unitPrice" min="0" class="price-input"
                         [readonly]="isTeaVariant(item.itemName)">
                </div>
                <div class="item-total">
                  <strong>‚Çπ{{ item.quantity * item.unitPrice }}</strong>
                </div>
                <button type="button" class="btn-remove" (click)="removeItem(i)" title="Delete item">üóëÔ∏è</button>
              </div>
            </div>
            <div class="total-amount">
              <strong>Total: {{ formatCurrency(getTotalAmount()) }}</strong>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea [(ngModel)]="formData.notes" rows="2" placeholder="Any additional notes..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn-primary" (click)="saveSales()" [disabled]="loading || formData.items.length === 0">
          {{ loading ? 'Saving...' : 'Save Sales' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div *ngIf="showUploadModal" class="modal-overlay" (click)="closeUploadModal()">
    <div class="modal-content upload-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>üì§ Upload Sales from Excel</h2>
        <button class="btn-close" (click)="closeUploadModal()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="upload-instructions">
          <h3>Excel Format</h3>
          <p>Columns: Date, ItemName, Quantity, UnitPrice, TotalSale, PaymentMethod</p>
          <button class="btn-template" (click)="downloadTemplate()">üì• Download Template</button>
        </div>

        <div class="file-upload-area">
          <input type="file" id="fileInput" accept=".xlsx,.xls" (change)="onFileSelected($event)" style="display: none;">
          <label for="fileInput" class="upload-label">
            <span *ngIf="!selectedFile">üìÇ Choose Excel File</span>
            <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
          </label>
        </div>

        <div *ngIf="uploadError" class="error-message">{{ uploadError }}</div>

        <div *ngIf="uploadResult" class="success-message">
          <h3>‚úÖ Upload Successful!</h3>
          <p>{{ uploadResult.message }}</p>
          <ul>
            <li>Processed Records: {{ uploadResult.processedRecords }}</li>
            <li>Total Amount: {{ formatCurrency(uploadResult.totalAmount) }}</li>
          </ul>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeUploadModal()">Close</button>
        <button class="btn-primary" (click)="uploadFile()" [disabled]="!selectedFile || uploading">
          {{ uploading ? 'Uploading...' : 'Upload' }}
        </button>
      </div>
    </div>
  </div>
</div>
