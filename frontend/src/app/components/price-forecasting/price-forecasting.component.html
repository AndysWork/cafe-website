<div class="price-forecasting-container">
  <div class="header">
    <h2>Price Forecasting</h2>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <i class="fas fa-plus"></i> New Price Forecast
    </button>
  </div>

  <div class="content">
    <div *ngIf="loading" class="loading">
      <div class="spinner"></div>
      <p>Loading price forecasts...</p>
    </div>

    <div *ngIf="!loading && forecasts.length === 0" class="empty-state">
      <i class="fas fa-chart-line fa-3x"></i>
      <p>No price forecasts found</p>
      <button class="btn btn-primary" (click)="openCreateModal()">Create First Forecast</button>
    </div>

    <div *ngIf="!loading && forecasts.length > 0" class="forecasts-grid">
      <div class="forecast-card" *ngFor="let forecast of forecasts">
        <div class="card-header">
          <h3>{{ forecast.menuItemName }}</h3>
          <span class="badge" [ngClass]="getStatusBadgeClass(forecast.isFinalized)">
            {{ getStatusText(forecast.isFinalized) }}
          </span>
        </div>

        <div class="card-body">
          <div class="price-section">
            <h4>Cost & Make Price</h4>
            <div class="price-row">
              <span class="label">Make Price:</span>
              <span class="value">₹{{ forecast.makePrice.toFixed(2) }}</span>
            </div>
            <div class="price-row">
              <span class="label">Packaging Cost:</span>
              <span class="value">₹{{ forecast.packagingCost.toFixed(2) }}</span>
            </div>
          </div>

          <div class="price-section">
            <h4>Shop Pricing</h4>
            <div class="price-row">
              <span class="label">Shop Price:</span>
              <span class="value">₹{{ forecast.shopPrice.toFixed(2) }}</span>
            </div>
            <div class="price-row">
              <span class="label">Takeaway Price:</span>
              <span class="value">₹{{ forecast.shopDeliveryPrice.toFixed(2) }}</span>
            </div>
          </div>

          <div class="price-section">
            <h4>Online Pricing</h4>
            <div class="price-row">
              <span class="label">Online Price:</span>
              <span class="value">₹{{ forecast.onlinePrice.toFixed(2) }}</span>
            </div>
            <div class="price-row">
              <span class="label">Online Deduction:</span>
              <span class="value">{{ forecast.onlineDeduction }}%</span>
            </div>
            <div class="price-row">
              <span class="label">Online Discount:</span>
              <span class="value">₹{{ forecast.onlineDiscount.toFixed(2) || '0.00' }}</span>
            </div>
          </div>

          <div class="price-section highlight">
            <h4>Profit Analysis</h4>
            <div class="price-row">
              <span class="label"><strong>Online Payout:</strong></span>
              <span class="value"><strong>₹{{ forecast.onlinePayout.toFixed(2) }}</strong></span>
            </div>
            <div class="price-row">
              <span class="label"><strong>Online Profit:</strong></span>
              <span class="value"><strong>₹{{ forecast.onlineProfit.toFixed(2) }}</strong></span>
            </div>
            <div class="price-row">
              <span class="label"><strong>Offline Profit:</strong></span>
              <span class="value"><strong>₹{{ forecast.offlineProfit.toFixed(2) }}</strong></span>
            </div>
            <div class="price-row">
              <span class="label"><strong>Takeaway Profit:</strong></span>
              <span class="value"><strong>₹{{ forecast.takeawayProfit.toFixed(2) }}</strong></span>
            </div>
          </div>

          <div class="card-footer">
            <div class="meta-info">
              <small>Created: {{ formatDate(forecast.createdDate) }} by {{ forecast.createdBy }}</small>
              <small *ngIf="forecast.finalizedDate">Finalized: {{ formatDate(forecast.finalizedDate) }} by {{ forecast.finalizedBy }}</small>
            </div>
            <div class="actions">
              <button class="btn btn-sm btn-info" (click)="showHistory(forecast)" *ngIf="forecast.history && forecast.history.length > 0">
                <i class="fas fa-history"></i> History ({{ forecast.history.length }})
              </button>
              <button class="btn btn-sm btn-secondary" (click)="openEditModal(forecast)" [disabled]="forecast.isFinalized">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="btn btn-sm btn-success" (click)="finalizeForecast(forecast.id!)" [disabled]="forecast.isFinalized">
                <i class="fas fa-check"></i> Finalize
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteForecast(forecast.id!, forecast.isFinalized)" [disabled]="forecast.isFinalized">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal" [class.show]="showModal" *ngIf="showModal">
  <div class="modal-backdrop" (click)="closeModal()"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>{{ isEditMode ? 'Edit' : 'Create' }} Price Forecast</h3>
      <button class="close-btn" (click)="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form>
        <div class="form-group">
          <label for="menuItem">Menu Item *</label>
          <select id="menuItem" [(ngModel)]="forecastForm.menuItemId" name="menuItemId"
                  (change)="onMenuItemChange()" [disabled]="isEditMode" required>
            <option value="">Select a menu item</option>
            <option *ngFor="let item of menuItems" [value]="item.id">{{ item.name }}</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="makePrice">Make Price (₹) *</label>
            <input type="number" id="makePrice" [(ngModel)]="forecastForm.makePrice"
                   name="makePrice" step="0.01" min="0" (input)="onPriceChange()" required>
          </div>

          <div class="form-group">
            <label for="packagingCost">Packaging Cost (₹) *</label>
            <input type="number" id="packagingCost" [(ngModel)]="forecastForm.packagingCost"
                   name="packagingCost" step="0.01" min="0" (input)="onPriceChange()" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="shopPrice">Shop Price (₹) *</label>
            <input type="number" id="shopPrice" [(ngModel)]="forecastForm.shopPrice"
                   name="shopPrice" step="0.01" min="0" (input)="onShopPriceChange()" required>
          </div>

          <div class="form-group">
            <label for="shopDeliveryPrice">Takeaway Price (₹) <small>(Auto-synced with Shop Price)</small></label>
            <input type="number" id="shopDeliveryPrice" [(ngModel)]="forecastForm.shopDeliveryPrice"
                   name="shopDeliveryPrice" step="0.01" min="0" readonly>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="onlinePrice">Online Price (₹) *</label>
            <input type="number" id="onlinePrice" [(ngModel)]="forecastForm.onlinePrice"
                   name="onlinePrice" step="0.01" min="0" (input)="onPriceChange()" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="updatedShopPrice">Updated Shop Price (₹)</label>
            <input type="number" id="updatedShopPrice" [(ngModel)]="forecastForm.updatedShopPrice"
                   name="updatedShopPrice" step="0.01" min="0" (input)="onPriceChange()">
            <small class="help-text">Optional: Set new shop price if planning to update</small>
          </div>

          <div class="form-group">
            <label for="updatedOnlinePrice">Updated Online Price (₹)</label>
            <input type="number" id="updatedOnlinePrice" [(ngModel)]="forecastForm.updatedOnlinePrice"
                   name="updatedOnlinePrice" step="0.01" min="0" (input)="onPriceChange()">
            <small class="help-text">Optional: Set new online price if planning to update</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="onlineDeduction">Online Deduction (%)</label>
            <input type="number" id="onlineDeduction" [(ngModel)]="forecastForm.onlineDeduction"
                   name="onlineDeduction" step="0.01" min="0" max="100" (input)="onPriceChange()">
          </div>

          <div class="form-group">
            <label for="onlineDiscount">Discount Coupon</label>
            <select id="onlineDiscount" [(ngModel)]="selectedCouponId"
                   name="selectedCouponId" (change)="onDiscountCouponChange()" class="discount-dropdown">
              <option value="none">No Discount</option>
              <option *ngFor="let coupon of activeCoupons" [value]="coupon.id">
                {{ coupon.couponCode }} - {{ coupon.platform }}
                <ng-container *ngIf="coupon.discountPercentage">({{ coupon.discountPercentage }}%</ng-container>
                <ng-container *ngIf="!coupon.discountPercentage">(Avg: ₹{{ coupon.averageDiscountAmount.toFixed(2) || '0.00' }}</ng-container>
                <ng-container *ngIf="coupon.maxValue">, Max: ₹{{ coupon.maxValue }}</ng-container>)
              </option>
            </select>
            <div *ngIf="forecastForm.onlineDiscount && forecastForm.onlineDiscount > 0" class="discount-info">
              Applied Discount: {{ forecastForm.onlineDiscount.toFixed(2) }}%
            </div>
            <div *ngIf="discountWarning" class="discount-warning"
                 [class.warning]="discountWarning.includes('⚠️')"
                 [class.success]="discountWarning.includes('✓')">
              {{ discountWarning }}
            </div>
          </div>
        </div>

        <div class="form-group highlight">
          <label>Profit Analysis</label>
          <div class="profit-grid">
            <div class="profit-item">
              <span class="profit-label">Online Payout</span>
              <span class="profit-value">₹{{ forecastForm.onlinePayout?.toFixed(2) || '0.00' }}</span>
            </div>
            <div class="profit-item">
              <span class="profit-label">Online Profit</span>
              <span class="profit-value">₹{{ forecastForm.onlineProfit?.toFixed(2) || '0.00' }}</span>
            </div>
            <div class="profit-item">
              <span class="profit-label">Offline Profit</span>
              <span class="profit-value">₹{{ forecastForm.offlineProfit?.toFixed(2) || '0.00' }}</span>
            </div>
            <div class="profit-item">
              <span class="profit-label">Takeaway Profit</span>
              <span class="profit-value">₹{{ forecastForm.takeawayProfit?.toFixed(2) || '0.00' }}</span>
            </div>
          </div>
          <small class="help-text">
            Online Payout = ((Price + Packaging) - Discount Amount) - (((Price + Packaging) - Discount Amount) × Deduction%)<br>
            Online Profit = Online Payout - Making Price<br>
            Offline Profit = Shop Price - Making Price<br>
            Takeaway Profit = Takeaway Price - (Making + Packaging)
          </small>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
      <button class="btn btn-primary" (click)="saveForecast()">{{ isEditMode ? 'Update' : 'Create' }}</button>
    </div>
  </div>
</div>

<!-- History Modal -->
<div class="modal" [class.show]="showHistoryModal" *ngIf="showHistoryModal">
  <div class="modal-backdrop" (click)="closeHistoryModal()"></div>
  <div class="modal-content modal-lg">
    <div class="modal-header">
      <h3>Price Change History</h3>
      <button class="close-btn" (click)="closeHistoryModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="history-timeline">
        <div class="history-entry" *ngFor="let entry of selectedHistory">
          <div class="history-header">
            <strong>{{ formatDate(entry.changeDate) }}</strong>
            <span>by {{ entry.changedBy }}</span>
          </div>
          <div class="history-details">
            <div class="detail-row">
              <span>Make Price:</span> <span>₹{{ entry.makePrice.toFixed(2) }}</span>
            </div>
            <div class="detail-row">
              <span>Packaging Cost:</span> <span>₹{{ entry.packagingCost.toFixed(2) }}</span>
            </div>
            <div class="detail-row">
              <span>Shop Price:</span> <span>₹{{ entry.shopPrice.toFixed(2) }}</span>
            </div>
            <div class="detail-row">
              <span>Takeaway Price:</span> <span>₹{{ entry.shopDeliveryPrice.toFixed(2) }}</span>
            </div>
            <div class="detail-row">
              <span>Online Price:</span> <span>₹{{ entry.onlinePrice.toFixed(2) }}</span>
            </div>
            <div class="detail-row" *ngIf="entry.updatedShopPrice > 0">
              <span>Updated Shop Price:</span> <span>₹{{ entry.updatedShopPrice.toFixed(2) }}</span>
            </div>
            <div class="detail-row" *ngIf="entry.updatedOnlinePrice > 0">
              <span>Updated Online Price:</span> <span>₹{{ entry.updatedOnlinePrice.toFixed(2) }}</span>
            </div>
            <div class="detail-row">
              <span>Online Deduction:</span> <span>{{ entry.onlineDeduction }}%</span>
            </div>
            <div class="detail-row">
              <span>Online Discount:</span> <span>₹{{ entry.onlineDiscount.toFixed(2) || '0.00' }}</span>
            </div>
            <div class="detail-row highlight">
              <span><strong>Online Payout:</strong></span> <span><strong>₹{{ entry.onlinePayout.toFixed(2) }}</strong></span>
            </div>
            <div class="detail-row highlight">
              <span><strong>Online Profit:</strong></span> <span><strong>₹{{ entry.onlineProfit.toFixed(2) }}</strong></span>
            </div>
            <div class="detail-row highlight">
              <span><strong>Offline Profit:</strong></span> <span><strong>₹{{ entry.offlineProfit.toFixed(2) }}</strong></span>
            </div>
            <div class="detail-row highlight">
              <span><strong>Takeaway Profit:</strong></span> <span><strong>₹{{ entry.takeawayProfit.toFixed(2) }}</strong></span>
            </div>
            <div class="detail-row" *ngIf="entry.changeReason">
              <span>Reason:</span> <span>{{ entry.changeReason }}</span>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="selectedHistory.length === 0" class="empty-state">
        <p>No history available</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeHistoryModal()">Close</button>
    </div>
  </div>
</div>
