<div class="operational-expenses-container">
  <div class="page-header">
    <h1>ğŸ’¼ Monthly Operational Expenses</h1>
    <div class="header-actions">
      <button class="btn-primary" (click)="openAddModal()">â• Add Monthly Expense</button>
    </div>
  </div>

  <div class="info-banner">
    <div class="info-icon">â„¹ï¸</div>
    <div class="info-content">
      <strong>About Operational Expenses:</strong>
      <ul>
        <li>Track monthly operational costs for your cafe</li>
        <li>Rent is automatically calculated from offline expenses</li>
        <li>All transactions are recorded as Cash</li>
        <li>One record per month - edit existing record to make changes</li>
      </ul>
    </div>
  </div>

  <!-- Expenses List -->
  <div class="expenses-list">
    <div *ngIf="loading" class="loading">Loading operational expenses...</div>

    <div *ngIf="!loading && expenses.length === 0" class="empty-state">
      <p>ğŸ“‹ No operational expense records found</p>
      <p>Click "Add Monthly Expense" to create your first record</p>
    </div>

    <!-- Year Grouped View -->
    <div *ngIf="!loading && expenses.length > 0" class="grouped-expenses">
      <div *ngFor="let year of getYears()" class="year-group">
        <!-- Year Header -->
        <div class="year-header" (click)="toggleYear(year)">
          <div class="year-info">
            <span class="expand-icon" [class.expanded]="isYearExpanded(year)">â–¶</span>
            <h2>ğŸ“… {{ year }}</h2>
            <span class="year-count">({{ groupedExpenses[year].length }} months)</span>
          </div>
          <div class="year-total">
            Total: {{ formatCurrency(getYearTotal(year)) }}
          </div>
        </div>

        <!-- Year Content -->
        <div *ngIf="isYearExpanded(year)" class="year-content">
          <div class="expense-cards">
            <div *ngFor="let expense of groupedExpenses[year]" class="expense-card">
              <div class="expense-header">
                <div class="expense-month">
                  ğŸ“† {{ getMonthName(expense.month) }} {{ expense.year }}
                </div>
                <div class="expense-total-badge">
                  {{ formatCurrency(expense.totalOperationalCost) }}
                </div>
              </div>

              <div class="expense-breakdown">
                <div class="breakdown-item">
                  <span class="breakdown-label">ğŸ  Rent:</span>
                  <span class="breakdown-value">{{ formatCurrency(expense.rent) }}</span>
                  <span class="breakdown-note">(Auto-calculated)</span>
                </div>
                <div class="breakdown-item">
                  <span class="breakdown-label">ğŸ‘¨â€ğŸ³ Cook Salary:</span>
                  <span class="breakdown-value">{{ formatCurrency(expense.cookSalary) }}</span>
                </div>
                <div class="breakdown-item">
                  <span class="breakdown-label">ğŸ‘· Helper Salary:</span>
                  <span class="breakdown-value">{{ formatCurrency(expense.helperSalary) }}</span>
                </div>
                <div class="breakdown-item">
                  <span class="breakdown-label">âš¡ Electricity:</span>
                  <span class="breakdown-value">{{ formatCurrency(expense.electricity) }}</span>
                </div>
                <div class="breakdown-item">
                  <span class="breakdown-label">ğŸ”§ Machine Maintenance:</span>
                  <span class="breakdown-value">{{ formatCurrency(expense.machineMaintenance) }}</span>
                </div>
                <div class="breakdown-item">
                  <span class="breakdown-label">ğŸ“ Misc:</span>
                  <span class="breakdown-value">{{ formatCurrency(expense.misc) }}</span>
                </div>
              </div>

              <div *ngIf="expense.notes" class="expense-notes">
                <em>Note: {{ expense.notes }}</em>
              </div>

              <div class="expense-footer">
                <div class="expense-meta">
                  <span>ğŸ’³ {{ expense.transactionType }}</span>
                  <span>ğŸ‘¤ {{ expense.recordedBy }}</span>
                  <span>ğŸ• {{ formatDate(expense.updatedAt) }}</span>
                </div>
                <div class="expense-actions">
                  <button class="btn-edit" (click)="openEditModal(expense)">âœï¸ Edit</button>
                  <button class="btn-delete" (click)="deleteExpense(expense.id)">ğŸ—‘ï¸ Delete</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditMode ? 'Edit' : 'Add' }} Monthly Operational Expense</h2>
        <button class="btn-close" (click)="closeModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <form class="expense-form">
          <!-- Month and Year Selection -->
          <div class="form-row">
            <div class="form-group">
              <label>Month *</label>
              <select [(ngModel)]="formData.month" name="month" [disabled]="isEditMode" (change)="calculateRent()" required>
                <option *ngFor="let month of months" [value]="month.value">{{ month.name }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Year *</label>
              <input type="number" [(ngModel)]="formData.year" name="year" [disabled]="isEditMode"
                     (change)="calculateRent()" min="2020" max="2100" required>
            </div>
          </div>

          <!-- Calculated Rent -->
          <div class="rent-display">
            <div class="rent-label">
              ğŸ  Rent (Auto-calculated from Offline Expenses):
              <button type="button" class="btn-refresh" (click)="calculateRent()" [disabled]="calculatingRent">
                {{ calculatingRent ? 'â³' : 'ğŸ”„' }} Refresh
              </button>
            </div>
            <div class="rent-value">{{ formatCurrency(calculatedRent) }}</div>
          </div>

          <!-- Salary Fields -->
          <div class="form-section">
            <h3>ğŸ’° Salaries</h3>
            <div class="form-row">
              <div class="form-group">
                <label>ğŸ‘¨â€ğŸ³ Cook Salary</label>
                <input type="number" [(ngModel)]="formData.cookSalary" name="cookSalary" min="0" step="100">
              </div>
              <div class="form-group">
                <label>ğŸ‘· Helper Salary</label>
                <input type="number" [(ngModel)]="formData.helperSalary" name="helperSalary" min="0" step="100">
              </div>
            </div>
          </div>

          <!-- Utility and Maintenance Fields -->
          <div class="form-section">
            <h3>ğŸ”§ Utilities & Maintenance</h3>
            <div class="form-row">
              <div class="form-group">
                <label>âš¡ Electricity</label>
                <input type="number" [(ngModel)]="formData.electricity" name="electricity" min="0" step="50">
              </div>
              <div class="form-group">
                <label>ğŸ”§ Machine Maintenance</label>
                <input type="number" [(ngModel)]="formData.machineMaintenance" name="machineMaintenance" min="0" step="50">
              </div>
            </div>
          </div>

          <!-- Miscellaneous -->
          <div class="form-group">
            <label>ğŸ“ Miscellaneous</label>
            <input type="number" [(ngModel)]="formData.misc" name="misc" min="0" step="50">
          </div>

          <!-- Notes -->
          <div class="form-group">
            <label>ğŸ“‹ Notes</label>
            <textarea [(ngModel)]="formData.notes" name="notes" rows="3"
                      placeholder="Additional notes about this month's operational expenses..."></textarea>
          </div>

          <!-- Total Display -->
          <div class="total-display">
            <div class="total-label">ğŸ’¼ Total Operational Cost:</div>
            <div class="total-value">{{ formatCurrency(getTotalOperationalCost()) }}</div>
          </div>

          <div class="info-note">
            <strong>Note:</strong> Transaction type is automatically set to <strong>Cash</strong> for all operational expenses.
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn-primary" (click)="saveExpense()" [disabled]="loading">
          {{ loading ? 'Saving...' : (isEditMode ? 'Update' : 'Create') }}
        </button>
      </div>
    </div>
  </div>
</div>
