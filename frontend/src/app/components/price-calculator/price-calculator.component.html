<div class="price-calculator-container">
  <!-- Header -->
  <div class="calculator-header">
    <div class="header-left">
      <span class="header-icon">üßÆ</span>
      <div class="header-text">
        <h1>Menu Item Price Calculator</h1>
        <p>Calculate accurate pricing for menu items based on ingredient costs and overheads</p>
      </div>
    </div>
  </div>

  <!-- Tab Navigation -->
  <div class="tab-navigation">
    <button
      class="tab-btn"
      [class.active]="activeTab === 'calculator'"
      (click)="activeTab = 'calculator'">
      <span class="tab-icon">üßÆ</span>
      Calculator
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'ingredients'"
      (click)="activeTab = 'ingredients'">
      <span class="tab-icon">ü•ï</span>
      Ingredients ({{ingredients.length}})
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'recipes'"
      (click)="activeTab = 'recipes'">
      <span class="tab-icon">üìã</span>
      Saved Recipes ({{recipes.length}})
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'overhead'"
      (click)="activeTab = 'overhead'">
      <span class="tab-icon">üí∞</span>
      Overhead Costs
    </button>
    <button
      class="tab-btn"
      [class.active]="activeTab === 'frozen'"
      (click)="activeTab = 'frozen'">
      <span class="tab-icon">üßä</span>
      Frozen Items ({{frozenItems.length}})
    </button>
  </div>

  <!-- CALCULATOR TAB -->
  <div class="tab-content" *ngIf="activeTab === 'calculator'">
    <div class="calculator-grid">
      <!-- Left Panel: Recipe Builder -->
      <div class="recipe-builder-panel">
        <div class="panel-header">
          <h2>üìù Recipe Builder</h2>
          <div class="header-actions">
            <button class="btn-action" (click)="newRecipe()" title="New Recipe">
              <span>‚ûï</span> New
            </button>
            <button class="btn-action btn-save" (click)="saveCurrentRecipe()" title="Save Recipe">
              <span>üíæ</span> Save
            </button>
          </div>
        </div>

        <!-- Menu Item Name -->
        <div class="form-section">
          <label>Menu Item Name <span class="required">*</span></label>
          <input
            type="text"
            list="menuItemsList"
            [(ngModel)]="currentRecipe.menuItemName"
            (change)="onMenuItemNameChange()"
            placeholder="e.g., Chicken Biryani, Paneer Butter Masala"
            class="form-input">
          <datalist id="menuItemsList">
            <option *ngFor="let item of menuItems" [value]="item.name"></option>
          </datalist>
          <small class="form-hint">üí° Start typing to select from existing menu items or enter a new name</small>
        </div>

        <!-- Add Ingredients Section -->
        <div class="form-section">
          <h3>ü•ò Add Ingredients</h3>
          <div class="add-ingredient-form">
            <div class="form-row">
              <div class="form-group">
                <label>Select Ingredient</label>
                <select
                  class="form-select"
                  [(ngModel)]="selectedIngredientId"
                  (change)="onIngredientSelect($event)">
                  <option value="">-- Choose Ingredient --</option>
                  <option *ngFor="let ing of filteredIngredients" [value]="ing.id">
                    {{ing.name}} (‚Çπ{{ing.marketPrice}}/{{ing.unit}})
                  </option>
                </select>
              </div>
              <div class="form-group form-group-small">
                <label>Quantity</label>
                <input
                  type="number"
                  [(ngModel)]="ingredientQuantity"
                  min="0"
                  step="0.01"
                  class="form-input">
              </div>
              <div class="form-group form-group-small">
                <label>Unit</label>
                <select class="form-select" [(ngModel)]="ingredientUnit">
                  <option *ngFor="let unit of units" [value]="unit.value">
                    {{unit.label}}
                  </option>
                </select>
              </div>
              <div class="form-group form-group-small">
                <label>
                  Price (‚Çπ/{{ingredientUnit}})
                  <span style="font-size: 0.75rem; color: #666;">*optional</span>
                </label>
                <input
                  type="number"
                  [(ngModel)]="customIngredientPrice"
                  min="0"
                  step="0.01"
                  [placeholder]="selectedIngredient ? '‚Çπ' + selectedIngredient.marketPrice : '0'"
                  class="form-input"
                  title="Override the default market price for this ingredient">
              </div>
              <div class="form-group form-group-btn">
                <button class="btn-add" (click)="addIngredientToRecipe()">
                  <span>‚ûï</span> Add
                </button>
              </div>
            </div>
            <small class="form-hint" style="display: block; margin-top: 0.5rem;">
              üí° Price field auto-fills with market price. Override it if you got a different price for this recipe.
            </small>
          </div>
        </div>

        <!-- Ingredients List -->
        <div class="ingredients-list" *ngIf="currentRecipe.ingredients.length > 0">
          <h4>üì¶ Ingredients ({{currentRecipe.ingredients.length}})</h4>
          <div class="ingredient-items">
            <div class="ingredient-item" *ngFor="let ing of currentRecipe.ingredients; let i = index">
              <div class="ingredient-info">
                <span class="ingredient-name">{{ing.ingredientName}}</span>
                <span class="ingredient-qty">
                  {{ing.quantity}} {{ing.unit}} &#64; ‚Çπ{{ing.unitPrice}}/{{ing.unit}}
                </span>
              </div>
              <div class="ingredient-actions">
                <span class="ingredient-cost">‚Çπ{{ing.totalCost.toFixed(2)}}</span>
                <button class="btn-remove" (click)="removeIngredientFromRecipe(i)" title="Remove">
                  ‚ùå
                </button>
              </div>
            </div>
          </div>
          <div class="ingredients-total">
            <strong>Ingredients Subtotal:</strong>
            <strong>‚Çπ{{currentRecipe.totalIngredientCost.toFixed(2)}}</strong>
          </div>
        </div>

        <!-- Overhead Costs -->
        <div class="form-section">
          <h3>üí∞ Overhead Costs (Per Item)</h3>

          <!-- Preparation Time Input -->
          <div class="form-group" style="margin-bottom: 1rem; background: #fff3cd; padding: 1rem; border-radius: 8px;">
            <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
              <span>‚è±Ô∏è Preparation Time (minutes)</span>
              <span style="font-size: 0.8rem; color: #666;">(for auto-calculation)</span>
              <span *ngIf="isLoadingKpt" style="font-size: 0.8rem; color: #3498db;">‚è≥ Loading KPT data...</span>
            </label>
            <input
              type="number"
              [(ngModel)]="preparationTimeMinutes"
              (change)="calculateOverheadCosts()"
              min="0"
              step="1"
              placeholder="e.g., 6 minutes"
              class="form-input">

            <!-- KPT Data Display -->
            <div *ngIf="kptData" style="margin-top: 0.75rem; padding: 0.75rem; background: #e7f3ff; border-radius: 6px; border-left: 3px solid #3498db;">
              <div style="font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50; font-size: 0.9rem;">
                üìä Real KPT Data (from {{kptData.orderCount}} orders):
              </div>
              <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.85rem;">
                <button
                  (click)="useKptValue('avg')"
                  class="kpt-btn"
                  [class.active]="preparationTimeMinutes === Math.round(kptData.avgPreparationTime)"
                  style="padding: 0.4rem 0.6rem; background: white; border: 1px solid #3498db; border-radius: 4px; cursor: pointer; text-align: left;">
                  <strong>Avg:</strong> {{kptData.avgPreparationTime.toFixed(1)}} min
                </button>
                <button
                  (click)="useKptValue('median')"
                  class="kpt-btn"
                  [class.active]="preparationTimeMinutes === Math.round(kptData.medianPreparationTime)"
                  style="padding: 0.4rem 0.6rem; background: white; border: 1px solid #3498db; border-radius: 4px; cursor: pointer; text-align: left;">
                  <strong>Median:</strong> {{kptData.medianPreparationTime.toFixed(1)}} min
                </button>
                <button
                  (click)="useKptValue('min')"
                  class="kpt-btn"
                  [class.active]="preparationTimeMinutes === Math.round(kptData.minPreparationTime)"
                  style="padding: 0.4rem 0.6rem; background: white; border: 1px solid #27ae60; border-radius: 4px; cursor: pointer; text-align: left;">
                  <strong>Min:</strong> {{kptData.minPreparationTime.toFixed(1)}} min
                </button>
                <button
                  (click)="useKptValue('max')"
                  class="kpt-btn"
                  [class.active]="preparationTimeMinutes === Math.round(kptData.maxPreparationTime)"
                  style="padding: 0.4rem 0.6rem; background: white; border: 1px solid #e74c3c; border-radius: 4px; cursor: pointer; text-align: left;">
                  <strong>Max:</strong> {{kptData.maxPreparationTime.toFixed(1)}} min
                </button>
              </div>
              <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #7f8c8d;">
                Std Dev: {{kptData.stdDeviation.toFixed(2)}} | Click to use value
              </div>
            </div>

            <small class="form-hint" *ngIf="kptMessage" [style.color]="kptMessage.includes('‚úÖ') ? '#27ae60' : '#e67e22'">
              {{kptMessage}}
            </small>
            <small class="form-hint" *ngIf="overheadAllocation && !kptMessage">
              ‚úÖ Overhead costs auto-calculated for {{preparationTimeMinutes}} minute(s) preparation time
            </small>
          </div>

          <!-- Overhead Cost Breakdown (if auto-calculated) -->
          <div class="overhead-breakdown" *ngIf="overheadAllocation && overheadAllocation.costs.length > 0"
               style="margin-bottom: 1rem; padding: 1rem; background: #e7f3ff; border-radius: 8px; border-left: 4px solid #0066cc;">
            <h4 style="margin: 0 0 0.75rem 0; font-size: 0.9rem; color: #0066cc;">
              ü§ñ Auto-Calculated Overhead Costs
            </h4>
            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
              <div *ngFor="let cost of overheadAllocation.costs"
                   style="display: flex; justify-content: space-between; font-size: 0.85rem;">
                <span>{{cost.costType}}: (‚Çπ{{cost.monthlyCost}}/month &#64; ‚Çπ{{cost.costPerMinute.toFixed(4)}}/min)</span>
                <strong>‚Çπ{{cost.allocatedCost.toFixed(2)}}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: bold;
                          padding-top: 0.5rem; border-top: 2px solid #0066cc; margin-top: 0.25rem;">
                <span>Total Overhead:</span>
                <strong style="color: #0066cc;">‚Çπ{{overheadAllocation.totalOverheadCost.toFixed(2)}}</strong>
              </div>
            </div>
          </div>

          <div class="overhead-grid">
            <div class="form-group">
              <label>Labour Charge (‚Çπ)</label>
              <input
                type="number"
                [(ngModel)]="currentRecipe.overheadCosts.labourCharge"
                (ngModelChange)="calculatePrice()"
                min="0"
                step="0.5"
                class="form-input"
                [disabled]="overheadAllocation !== null"
                [title]="overheadAllocation ? 'Auto-calculated based on preparation time' : 'Manual entry'">
            </div>
            <div class="form-group">
              <label>Rent Allocation (‚Çπ)</label>
              <input
                type="number"
                [(ngModel)]="currentRecipe.overheadCosts.rentAllocation"
                (ngModelChange)="calculatePrice()"
                min="0"
                step="0.5"
                class="form-input"
                [disabled]="overheadAllocation !== null"
                [title]="overheadAllocation ? 'Auto-calculated based on preparation time' : 'Manual entry'">
            </div>
            <div class="form-group">
              <label>Electricity (‚Çπ)</label>
              <input
                type="number"
                [(ngModel)]="currentRecipe.overheadCosts.electricityCharge"
                (ngModelChange)="calculatePrice()"
                min="0"
                step="0.5"
                class="form-input"
                [disabled]="overheadAllocation !== null"
                [title]="overheadAllocation ? 'Auto-calculated based on preparation time' : 'Manual entry'">
            </div>
            <div class="form-group">
              <label>Wastage (%)</label>
              <input
                type="number"
                [(ngModel)]="currentRecipe.overheadCosts.wastagePercentage"
                (ngModelChange)="calculatePrice()"
                min="0"
                max="100"
                step="1"
                class="form-input">
            </div>
            <div class="form-group">
              <label>Miscellaneous (‚Çπ)</label>
              <input
                type="number"
                [(ngModel)]="currentRecipe.overheadCosts.miscellaneous"
                (ngModelChange)="calculatePrice()"
                min="0"
                step="0.5"
                class="form-input">
            </div>
          </div>
        </div>

        <!-- Profit Margin -->
        <div class="form-section">
          <h3>üìà Profit Margin</h3>
          <div class="form-group">
            <label>Profit Margin (%)</label>
            <input
              type="number"
              [(ngModel)]="currentRecipe.profitMargin"
              (ngModelChange)="calculatePrice()"
              min="0"
              max="200"
              step="5"
              class="form-input">
          </div>
        </div>

        <!-- Notes -->
        <div class="form-section">
          <label>Notes (Optional)</label>
          <textarea
            [(ngModel)]="currentRecipe.notes"
            placeholder="Add any notes about this recipe..."
            class="form-textarea"
            rows="3"></textarea>
        </div>
      </div>

      <!-- Right Panel: Cost Breakdown -->
      <div class="cost-breakdown-panel">
        <div class="panel-header">
          <h2>üíµ Cost Breakdown</h2>
        </div>

        <div class="breakdown-content" *ngIf="calculation; else noCalculation">
          <!-- Summary Cards -->
          <div class="summary-cards">
            <div class="summary-card card-making">
              <div class="card-label">Total Making Cost</div>
              <div class="card-value">‚Çπ{{calculation.breakdown.makingCost.toFixed(2)}}</div>
            </div>
            <div class="summary-card card-selling">
              <div class="card-label">Suggested Selling Price</div>
              <div class="card-value">‚Çπ{{calculation.breakdown.sellingPrice.toFixed(2)}}</div>
            </div>
          </div>

          <!-- Detailed Breakdown -->
          <div class="breakdown-section">
            <h4>üßæ Detailed Cost Analysis</h4>

            <!-- Ingredient Costs -->
            <div class="breakdown-group">
              <div class="breakdown-header">
                <span>üì¶ Ingredient Costs</span>
                <span class="breakdown-amount">‚Çπ{{calculation.breakdown.ingredientSubtotal.toFixed(2)}}</span>
              </div>
              <div class="breakdown-items">
                <div class="breakdown-item" *ngFor="let ing of calculation.breakdown.ingredients">
                  <span class="item-name">{{ing.ingredientName}} ({{ing.quantity}} {{ing.unit}})</span>
                  <span class="item-value">‚Çπ{{ing.totalCost.toFixed(2)}}</span>
                </div>
              </div>
            </div>

            <!-- Overhead Costs -->
            <div class="breakdown-group">
              <div class="breakdown-header">
                <span>üè¢ Overhead Costs</span>
                <span class="breakdown-amount">‚Çπ{{calculation.breakdown.overheadSubtotal.toFixed(2)}}</span>
              </div>
              <div class="breakdown-items">
                <div class="breakdown-item">
                  <span class="item-name">üë∑ Labour Charge</span>
                  <span class="item-value">‚Çπ{{calculation.breakdown.labour.toFixed(2)}}</span>
                </div>
                <div class="breakdown-item">
                  <span class="item-name">üè† Rent Allocation</span>
                  <span class="item-value">‚Çπ{{calculation.breakdown.rent.toFixed(2)}}</span>
                </div>
                <div class="breakdown-item">
                  <span class="item-name">‚ö° Electricity</span>
                  <span class="item-value">‚Çπ{{calculation.breakdown.electricity.toFixed(2)}}</span>
                </div>
                <div class="breakdown-item">
                  <span class="item-name">üóëÔ∏è Wastage ({{currentRecipe.overheadCosts.wastagePercentage}}%)</span>
                  <span class="item-value">‚Çπ{{calculation.breakdown.wastage.toFixed(2)}}</span>
                </div>
                <div class="breakdown-item">
                  <span class="item-name">üìå Miscellaneous</span>
                  <span class="item-value">‚Çπ{{calculation.breakdown.miscellaneous.toFixed(2)}}</span>
                </div>
              </div>
            </div>

            <!-- Profit -->
            <div class="breakdown-group">
              <div class="breakdown-header">
                <span>üìà Profit ({{calculation.breakdown.profitPercentage}}%)</span>
                <span class="breakdown-amount profit">‚Çπ{{calculation.breakdown.profitAmount.toFixed(2)}}</span>
              </div>
            </div>

            <!-- Final Price -->
            <div class="final-price-box">
              <div class="price-row">
                <span class="price-label">Making Cost:</span>
                <span class="price-value">‚Çπ{{calculation.breakdown.makingCost.toFixed(2)}}</span>
              </div>
              <div class="price-row">
                <span class="price-label">Profit:</span>
                <span class="price-value">‚Çπ{{calculation.breakdown.profitAmount.toFixed(2)}}</span>
              </div>
              <div class="price-row price-total">
                <span class="price-label">Final Selling Price:</span>
                <span class="price-value">‚Çπ{{calculation.breakdown.sellingPrice.toFixed(2)}}</span>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noCalculation>
          <div class="no-data-state">
            <span class="no-data-icon">üìä</span>
            <p>Add ingredients to see cost breakdown</p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- INGREDIENTS TAB -->
  <div class="tab-content" *ngIf="activeTab === 'ingredients'">
    <div class="ingredients-management">
      <div class="management-header">
        <div class="search-filter">
          <input
            type="text"
            [(ngModel)]="ingredientSearchTerm"
            placeholder="üîç Search ingredients..."
            class="search-input">
          <select class="filter-select" [(ngModel)]="selectedCategory">
            <option value="">All Categories</option>
            <option *ngFor="let cat of categories" [value]="cat.value">
              {{cat.label}}
            </option>
          </select>
        </div>
        <div class="management-actions">
          <button class="btn-primary" (click)="openIngredientModal()">
            <span>‚ûï</span> Add Ingredient
          </button>
          <button class="btn-secondary" (click)="bulkRefreshPrices()" [disabled]="isRefreshingPrice">
            <span>{{ isRefreshingPrice ? '‚è≥' : 'üîÑ' }}</span> Bulk Refresh Prices
          </button>
          <button class="btn-secondary" (click)="resetIngredients()">
            <span>üîÑ</span> Reset to Defaults
          </button>
        </div>
      </div>

      <div class="ingredients-grid">
        <div class="ingredient-card" *ngFor="let ing of filteredIngredients">
          <div class="card-header">
            <h4>{{ing.name}}</h4>
            <div class="card-badges">
              <span class="category-badge">{{getCategoryLabel(ing.category)}}</span>
              <span class="source-badge" [ngClass]="getPriceSourceBadge(ing.priceSource).class">
                {{getPriceSourceBadge(ing.priceSource).label}}
              </span>
            </div>
          </div>
          <div class="card-body">
            <!-- Inline Edit Mode -->
            <div class="inline-edit-mode" *ngIf="isEditingInline(ing)">
              <div class="inline-edit-form">
                <div class="form-group">
                  <label>Price (‚Çπ)</label>
                  <input type="number"
                         [(ngModel)]="inlineEditForm.price"
                         min="0"
                         step="0.5"
                         class="form-input"
                         (keyup.enter)="saveInlineEdit(ing)"
                         (keyup.escape)="cancelInlineEdit()">
                </div>
                <div class="form-group">
                  <label>Unit</label>
                  <select [(ngModel)]="inlineEditForm.unit" class="form-input">
                    <option *ngFor="let unit of measurementUnits" [value]="unit.value">
                      {{unit.label}}
                    </option>
                  </select>
                </div>
                <div class="inline-edit-actions">
                  <button class="btn-save" (click)="saveInlineEdit(ing)">
                    ‚úì Save
                  </button>
                  <button class="btn-cancel" (click)="cancelInlineEdit()">
                    ‚úï Cancel
                  </button>
                </div>
              </div>
            </div>

            <!-- Display Mode -->
            <div class="price-display" *ngIf="!isEditingInline(ing)">
              <span class="price-label">Market Price:</span>
              <span class="price-amount">‚Çπ{{ing.marketPrice}}/{{ing.unit}}</span>
              <span *ngIf="ing.priceChangePercentage"
                    class="price-change"
                    [ngClass]="getPriceChangeClass(ing.priceChangePercentage)">
                {{ing.priceChangePercentage > 0 ? '+' : ''}}{{ing.priceChangePercentage.toFixed(2)}}%
              </span>
              <button class="btn-inline-edit" (click)="startInlineEdit(ing)" title="Quick Edit Price">
                ‚úèÔ∏è
              </button>
            </div>
            <div class="meta-info" *ngIf="!isEditingInline(ing)">
              <span class="meta-item">üìè Unit: {{getUnitLabel(ing.unit)}}</span>
              <span class="meta-item" *ngIf="ing.lastPriceFetch">
                üïê Updated: {{ing.lastPriceFetch | date:'short'}}
              </span>
            </div>
            <div class="auto-update-toggle" *ngIf="ing.id && !isEditingInline(ing)">
              <label class="toggle-label">
                <input type="checkbox"
                       [checked]="ing.autoUpdateEnabled"
                       (change)="toggleAutoUpdate(ing)">
                <span class="toggle-text">Auto-update enabled</span>
              </label>
            </div>
          </div>
          <div class="card-footer" *ngIf="!isEditingInline(ing)">
            <button class="btn-icon" (click)="openIngredientModal(ing)" title="Full Edit">
              ‚öôÔ∏è
            </button>
            <button class="btn-icon"
                    (click)="refreshIngredientPrice(ing)"
                    [disabled]="refreshingIngredientId === ing.id"
                    title="Refresh Price">
              {{ refreshingIngredientId === ing.id ? '‚è≥' : 'üîÑ' }}
            </button>
            <button class="btn-icon"
                    (click)="openPriceHistory(ing)"
                    title="Price History">
              üìä
            </button>
            <button class="btn-icon btn-delete" (click)="deleteIngredient(ing.id)" title="Delete">
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>

      <div class="no-data-state" *ngIf="filteredIngredients.length === 0">
        <span class="no-data-icon">ü•ï</span>
        <p>No ingredients found</p>
      </div>
    </div>
  </div>

  <!-- RECIPES TAB -->
  <div class="tab-content" *ngIf="activeTab === 'recipes'">
    <div class="recipes-management">
      <div class="recipes-grid">
        <div class="recipe-card" *ngFor="let recipe of recipes">
          <div class="card-header">
            <h4>{{recipe.menuItemName}}</h4>
          </div>
          <div class="card-body">
            <div class="recipe-stats">
              <div class="stat-item">
                <span class="stat-label">Ingredients:</span>
                <span class="stat-value">{{recipe.ingredients.length}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Making Cost:</span>
                <span class="stat-value">‚Çπ{{recipe.totalMakingCost.toFixed(2)}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Selling Price:</span>
                <span class="stat-value selling">‚Çπ{{recipe.suggestedSellingPrice.toFixed(2)}}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Profit:</span>
                <span class="stat-value profit">{{recipe.profitMargin}}%</span>
              </div>
            </div>
          </div>
          <div class="card-footer">
            <button class="btn-edit" (click)="loadRecipe(recipe)">
              <span>üìù</span> Edit
            </button>
            <button class="btn-delete" (click)="deleteRecipe(recipe.id)">
              <span>üóëÔ∏è</span> Delete
            </button>
          </div>
        </div>
      </div>

      <div class="no-data-state" *ngIf="recipes.length === 0">
        <span class="no-data-icon">üìã</span>
        <p>No saved recipes yet</p>
        <button class="btn-primary" (click)="activeTab = 'calculator'">
          Create Your First Recipe
        </button>
      </div>
    </div>
  </div>

  <!-- INGREDIENT MODAL -->
  <div class="modal-overlay" *ngIf="showIngredientModal" (click)="closeIngredientModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{editingIngredient ? 'Edit' : 'Add'}} Ingredient</h3>
        <button class="btn-close" (click)="closeIngredientModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Ingredient Name <span class="required">*</span></label>
          <input
            type="text"
            [(ngModel)]="ingredientForm.name"
            placeholder="e.g., Onion, Tomato"
            class="form-input">
        </div>
        <div class="form-group">
          <label>Category <span class="required">*</span></label>
          <select class="form-select" [(ngModel)]="ingredientForm.category">
            <option *ngFor="let cat of categories" [value]="cat.value">
              {{cat.label}}
            </option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Market Price (‚Çπ) <span class="required">*</span></label>
            <input
              type="number"
              [(ngModel)]="ingredientForm.marketPrice"
              min="0"
              step="0.01"
              class="form-input">
          </div>
          <div class="form-group">
            <label>Unit <span class="required">*</span></label>
            <select class="form-select" [(ngModel)]="ingredientForm.unit">
              <option *ngFor="let unit of units" [value]="unit.value">
                {{unit.label}}
              </option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeIngredientModal()">Cancel</button>
        <button class="btn-primary" (click)="saveIngredient()">
          {{editingIngredient ? 'Update' : 'Add'}} Ingredient
        </button>
      </div>
    </div>
  </div>

  <!-- Price History Modal -->
  <div class="modal-overlay" *ngIf="showPriceHistoryModal" (click)="closePriceHistory()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üìä Price History: {{selectedIngredientForHistory?.name}}</h3>
        <button class="btn-close" (click)="closePriceHistory()">‚úñ</button>
      </div>
      <div class="modal-body">
        <!-- Price Chart -->
        <div class="price-chart-section" *ngIf="getChartData().labels.length > 0">
          <h4>Price Trend (Last 30 Days)</h4>
          <div class="simple-chart">
            <div class="chart-container">
              <div class="chart-y-axis">
                <div class="y-label">‚Çπ{{getChartData().values[getChartData().values.length - 1].toFixed(0)}}</div>
                <div class="y-label">‚Çπ{{getChartAverage().toFixed(0)}}</div>
                <div class="y-label">‚Çπ{{getChartData().values[0].toFixed(0)}}</div>
              </div>
              <div class="chart-area">
                <svg viewBox="0 0 800 300" class="line-chart">
                  <polyline
                    [attr.points]="getChartPoints()"
                    fill="none"
                    stroke="#4caf50"
                    stroke-width="3"
                    stroke-linejoin="round"
                  />
                  <g *ngFor="let val of getChartData().values; let idx = index">
                    <circle
                      [attr.cx]="getChartPointX(idx)"
                      [attr.cy]="getChartPointY(val)"
                      r="5"
                      fill="#4caf50"
                    />
                  </g>
                </svg>
              </div>
            </div>
            <div class="chart-x-axis">
              <div class="x-label">{{getChartData().labels[0]}}</div>
              <div class="x-label">{{getChartMidLabel()}}</div>
              <div class="x-label">{{getChartData().labels[getChartData().labels.length - 1]}}</div>
            </div>
          </div>
        </div>

        <!-- Price History Table -->
        <div class="price-history-section">
          <h4>Recent Price Changes</h4>
          <div class="history-table" *ngIf="priceHistory.length > 0">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Price</th>
                  <th>Change</th>
                  <th>Source</th>
                  <th>Market</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let record of priceHistory">
                  <td>{{record.recordedAt | date:'medium'}}</td>
                  <td>‚Çπ{{record.price}}/{{record.unit}}</td>
                  <td>
                    <span *ngIf="record.changePercentage"
                          [ngClass]="getPriceChangeClass(record.changePercentage)">
                      {{record.changePercentage > 0 ? '+' : ''}}{{record.changePercentage?.toFixed(2)}}%
                    </span>
                    <span *ngIf="!record.changePercentage">-</span>
                  </td>
                  <td>
                    <span class="source-badge" [ngClass]="getPriceSourceBadge(record.source).class">
                      {{getPriceSourceBadge(record.source).label}}
                    </span>
                  </td>
                  <td>{{record.marketName || '-'}}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="no-data-state" *ngIf="priceHistory.length === 0">
            <span class="no-data-icon">üìà</span>
            <p>No price history available</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closePriceHistory()">Close</button>
      </div>
    </div>
  </div>

  <!-- OVERHEAD COSTS TAB -->
  <div class="tab-content" *ngIf="activeTab === 'overhead'">
    <div class="overhead-costs-container">
      <div class="panel-header">
        <div class="header-left">
          <h2>üí∞ Overhead Cost Management</h2>
          <p class="subtitle">Configure monthly overhead costs with auto-calculation based on preparation time</p>
        </div>
        <div class="header-actions">
          <button class="btn-action" (click)="openOverheadModal()" title="Add New Overhead Cost">
            <span>‚ûï</span> Add Overhead Cost
          </button>
          <button class="btn-action btn-secondary" (click)="initializeDefaultOverheadCosts()"
                  title="Initialize Default Costs" *ngIf="overheadCosts.length === 0">
            <span>üîÑ</span> Initialize Defaults
          </button>
        </div>
      </div>

      <!-- Info Banner -->
      <div class="info-banner">
        <div class="info-icon">‚ÑπÔ∏è</div>
        <div class="info-content">
          <strong>How Auto-Calculation Works:</strong>
          <p>Monthly Cost ‚Üí Daily (√∑{{overheadCosts?.[0]?.workingDaysPerMonth || 30}} days) ‚Üí
             Hourly (√∑{{overheadCosts?.[0]?.operationalHoursPerDay || 11}} hrs) ‚Üí
             Per Minute (√∑60) ‚Üí Allocated (√óprep_time)</p>
          <p><strong>Example:</strong> Rent ‚Çπ6000/month ‚Üí ‚Çπ200/day ‚Üí ‚Çπ18.18/hr ‚Üí ‚Çπ0.303/min ‚Üí ‚Çπ1.82 for 6-min dish</p>
        </div>
      </div>

      <!-- Overhead Costs List -->
      <div class="overhead-costs-grid">
        <div class="overhead-cost-card" *ngFor="let cost of overheadCosts">
          <div class="card-header">
            <div class="card-title">
              <span class="cost-type-icon">üíº</span>
              <h3>{{cost.costType}}</h3>
              <span class="status-badge" [class.active]="cost.isActive" [class.inactive]="!cost.isActive">
                {{cost.isActive ? '‚úÖ Active' : '‚ùå Inactive'}}
              </span>
            </div>
            <div class="card-actions">
              <button class="btn-icon" (click)="openOverheadModal(cost)" title="Edit">
                ‚úèÔ∏è
              </button>
              <button class="btn-icon btn-danger" (click)="deleteOverheadCost(cost.id)" title="Delete">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <div class="card-body">
            <div class="cost-details">
              <div class="detail-row">
                <span class="detail-label">Monthly Cost:</span>
                <span class="detail-value primary">‚Çπ{{cost.monthlyCost.toFixed(2)}}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Operational Hours/Day:</span>
                <span class="detail-value">{{cost.operationalHoursPerDay}} hrs</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Working Days/Month:</span>
                <span class="detail-value">{{cost.workingDaysPerMonth}} days</span>
              </div>
            </div>

            <div class="cost-breakdown">
              <h4>Auto-Calculated Rates:</h4>
              <div class="breakdown-item">
                <span>Cost per Day:</span>
                <strong>‚Çπ{{cost.costPerDay?.toFixed(2)}}</strong>
              </div>
              <div class="breakdown-item">
                <span>Cost per Hour:</span>
                <strong>‚Çπ{{cost.costPerHour?.toFixed(2)}}</strong>
              </div>
              <div class="breakdown-item highlight">
                <span>Cost per Minute:</span>
                <strong>‚Çπ{{cost.costPerMinute?.toFixed(4)}}</strong>
              </div>
            </div>

            <div class="cost-description" *ngIf="cost.description">
              <small>üìù {{cost.description}}</small>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="overheadCosts.length === 0">
          <span class="empty-icon">üí∞</span>
          <h3>No Overhead Costs Configured</h3>
          <p>Add overhead costs to enable auto-calculation based on preparation time</p>
          <button class="btn-primary" (click)="initializeDefaultOverheadCosts()">
            <span>üîÑ</span> Initialize Default Costs
          </button>
        </div>
      </div>

      <!-- Calculation Example -->
      <div class="calculation-example-section" *ngIf="overheadCosts.length > 0">
        <h3>üßÆ Test Auto-Calculation</h3>
        <div class="example-form">
          <div class="form-group">
            <label>Preparation Time (minutes):</label>
            <input
              type="number"
              [(ngModel)]="preparationTimeMinutes"
              min="1"
              step="1"
              placeholder="e.g., 6"
              class="form-input">
          </div>
          <button class="btn-primary" (click)="calculateOverheadCosts()"
                  [disabled]="preparationTimeMinutes <= 0">
            Calculate
          </button>
        </div>

        <!-- Calculation Result -->
        <div class="calculation-result" *ngIf="overheadAllocation">
          <h4>Allocation for {{overheadAllocation.preparationTimeMinutes}} minute(s):</h4>
          <div class="result-breakdown">
            <div class="result-item" *ngFor="let calc of overheadAllocation.costs">
              <div class="result-label">
                <span>{{calc.costType}}</span>
                <small>(‚Çπ{{calc.monthlyCost}}/month &#64; ‚Çπ{{calc.costPerMinute.toFixed(4)}}/min)</small>
              </div>
              <div class="result-value">‚Çπ{{calc.allocatedCost.toFixed(2)}}</div>
            </div>
            <div class="result-item total">
              <div class="result-label"><strong>Total Overhead Cost:</strong></div>
              <div class="result-value"><strong>‚Çπ{{overheadAllocation.totalOverheadCost.toFixed(2)}}</strong></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FROZEN ITEMS TAB -->
  <div class="tab-content" *ngIf="activeTab === 'frozen'">
    <div class="frozen-items-container">
      <div class="panel-header">
        <div class="header-left">
          <h2>üßä Frozen Items Management</h2>
          <p class="subtitle">Upload frozen items via Excel or add them manually</p>
        </div>
        <!-- <div class="header-actions">
          <button class="btn-action" (click)="downloadExcelTemplate()" title="Download Template">
            <span>üì•</span> Download Template
          </button>
          <button class="btn-action btn-primary" (click)="openFrozenModal()" title="Add Frozen Item">
            <span>‚ûï</span> Add Item
          </button>
        </div> -->
      </div>

      <!-- Excel Upload Section -->
      <div class="upload-section">
        <div class="upload-card">
          <div class="upload-icon">üì§</div>
          <h3>Upload Excel File</h3>
          <p>Upload an Excel file with frozen items data. Required columns: ItemName, Quantity, PacketWeight, BuyPrice, PerPiecePrice, PerPieceWeight, Vendor</p>

          <div class="upload-form">
            <input
              type="file"
              accept=".xlsx,.xls"
              (change)="onFileSelected($event)"
              class="file-input"
              id="excelFile">
            <label for="excelFile" class="file-label">
              <span *ngIf="!selectedFile">üìé Choose Excel File</span>
              <span *ngIf="selectedFile">‚úÖ {{selectedFile.name}}</span>
            </label>
            <button
              class="btn-upload"
              (click)="uploadExcelFile()"
              [disabled]="!selectedFile || uploadProgress">
              <span *ngIf="!uploadProgress">‚¨ÜÔ∏è Upload</span>
              <span *ngIf="uploadProgress">‚è≥ Uploading...</span>
            </button>
          </div>

          <!-- Upload Result -->
          <div class="upload-result" *ngIf="uploadResult">
            <div class="result-summary" [ngClass]="uploadResult.failed === 0 ? 'success' : 'warning'">
              <strong>Upload Complete:</strong> {{uploadResult.success}} successful, {{uploadResult.failed}} failed
            </div>
            <div class="result-errors" *ngIf="uploadResult.errors.length > 0">
              <h4>Errors:</h4>
              <ul>
                <li *ngFor="let error of uploadResult.errors">{{error}}</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Frozen Items Grid -->
      <div class="frozen-items-grid">
        <div class="frozen-item-card" *ngFor="let item of frozenItems">
          <div class="card-header">
            <div class="card-title">
              <span class="item-icon">üßä</span>
              <h3>{{item.itemName}}</h3>
              <span class="status-badge" [class.active]="item.isActive" [class.inactive]="!item.isActive">
                {{item.isActive ? '‚úÖ Active' : '‚ùå Inactive'}}
              </span>
            </div>
            <div class="card-actions">
              <button class="btn-icon" (click)="openFrozenModal(item)" title="Edit">
                ‚úèÔ∏è
              </button>
              <button class="btn-icon btn-danger" (click)="deleteFrozenItem(item.id)" title="Delete">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <div class="card-body">
            <div class="item-details">
              <div class="detail-row">
                <span class="detail-label">Vendor:</span>
                <span class="detail-value">{{item.vendor}}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Quantity:</span>
                <span class="detail-value">{{item.quantity}} pieces</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Packet Weight:</span>
                <span class="detail-value">{{item.packetWeight}} kg</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Buy Price:</span>
                <span class="detail-value primary">‚Çπ{{item.buyPrice.toFixed(2)}}</span>
              </div>
            </div>

            <div class="per-piece-info">
              <h4>Per Piece Details:</h4>
              <div class="piece-grid">
                <div class="piece-item">
                  <span class="piece-label">Price/Piece:</span>
                  <strong>‚Çπ{{item.perPiecePrice.toFixed(2)}}</strong>
                </div>
                <div class="piece-item">
                  <span class="piece-label">Weight/Piece:</span>
                  <strong>{{item.perPieceWeight}} gm</strong>
                </div>
              </div>
            </div>

            <div class="item-notes" *ngIf="item.notes">
              <small>üìù {{item.notes}}</small>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="frozenItems.length === 0">
          <span class="empty-icon">üßä</span>
          <h3>No Frozen Items</h3>
          <p>Upload an Excel file or add items manually to get started</p>
          <div class="empty-actions">
            <button class="btn-primary" (click)="downloadExcelTemplate()">
              <span>üì•</span> Download Template
            </button>
            <button class="btn-secondary" (click)="openFrozenModal()">
              <span>‚ûï</span> Add Item
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Frozen Item Modal -->
  <div class="modal-overlay" *ngIf="showFrozenModal" (click)="closeFrozenModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{editingFrozenItem ? '‚úèÔ∏è Edit' : '‚ûï Add'}} Frozen Item</h3>
        <button class="btn-close" (click)="closeFrozenModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Item Name <span class="required">*</span></label>
          <input
            type="text"
            [(ngModel)]="frozenForm.itemName"
            placeholder="e.g., Frozen Chicken Wings"
            class="form-input">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Quantity (Pieces) <span class="required">*</span></label>
            <input
              type="number"
              [(ngModel)]="frozenForm.quantity"
              min="0"
              step="1"
              class="form-input">
          </div>

          <div class="form-group">
            <label>Packet Weight (kg) <span class="required">*</span></label>
            <input
              type="number"
              [(ngModel)]="frozenForm.packetWeight"
              min="0"
              step="0.01"
              class="form-input">
          </div>
        </div>

        <div class="form-group">
          <label>Buy Price (‚Çπ) <span class="required">*</span></label>
          <input
            type="number"
            [(ngModel)]="frozenForm.buyPrice"
            min="0"
            step="0.01"
            class="form-input">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Per Piece Price (‚Çπ)</label>
            <input
              type="number"
              [(ngModel)]="frozenForm.perPiecePrice"
              min="0"
              step="0.01"
              class="form-input">
          </div>

          <div class="form-group">
            <label>Per Piece Weight (gm)</label>
            <input
              type="number"
              [(ngModel)]="frozenForm.perPieceWeight"
              min="0"
              step="0.01"
              class="form-input">
          </div>
        </div>

        <div class="form-group">
          <label>Vendor <span class="required">*</span></label>
          <input
            type="text"
            [(ngModel)]="frozenForm.vendor"
            placeholder="e.g., ABC Suppliers"
            class="form-input">
        </div>

        <div class="form-group">
          <label>Notes (Optional)</label>
          <textarea
            [(ngModel)]="frozenForm.notes"
            placeholder="Additional notes..."
            class="form-textarea"
            rows="3"></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="frozenForm.isActive">
            <span>Active (Available for use)</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeFrozenModal()">Cancel</button>
        <button class="btn-primary" (click)="saveFrozenItem()">
          {{editingFrozenItem ? 'Update' : 'Add'}} Item
        </button>
      </div>
    </div>
  </div>

  <!-- Overhead Cost Modal -->
  <div class="modal-overlay" *ngIf="showOverheadModal" (click)="closeOverheadModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{editingOverheadCost ? '‚úèÔ∏è Edit' : '‚ûï Add'}} Overhead Cost</h3>
        <button class="btn-close" (click)="closeOverheadModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Cost Type <span class="required">*</span></label>
          <input
            type="text"
            [(ngModel)]="overheadForm.costType"
            placeholder="e.g., Rent, Labour, Electricity"
            class="form-input">
        </div>

        <div class="form-group">
          <label>Monthly Cost (‚Çπ) <span class="required">*</span></label>
          <input
            type="number"
            [(ngModel)]="overheadForm.monthlyCost"
            min="0"
            step="100"
            placeholder="e.g., 6000"
            class="form-input">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Operational Hours/Day <span class="required">*</span></label>
            <input
              type="number"
              [(ngModel)]="overheadForm.operationalHoursPerDay"
              min="1"
              max="24"
              step="1"
              class="form-input">
          </div>

          <div class="form-group">
            <label>Working Days/Month <span class="required">*</span></label>
            <input
              type="number"
              [(ngModel)]="overheadForm.workingDaysPerMonth"
              min="1"
              max="31"
              step="1"
              class="form-input">
          </div>
        </div>

        <div class="form-group">
          <label>Description (Optional)</label>
          <textarea
            [(ngModel)]="overheadForm.description"
            placeholder="Brief description of this overhead cost..."
            class="form-textarea"
            rows="3"></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              [(ngModel)]="overheadForm.isActive">
            <span>Active (Include in calculations)</span>
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeOverheadModal()">Cancel</button>
        <button class="btn-primary" (click)="saveOverheadCost()">
          {{editingOverheadCost ? 'Update' : 'Add'}} Overhead Cost
        </button>
      </div>
    </div>
  </div>

  <!-- Alert Notifications -->
  <div class="alert-container">
    <div class="alert"
         *ngFor="let alert of priceAlerts"
         [ngClass]="'alert-' + alert.type">
      <div class="alert-content">
        <span class="alert-message">{{alert.message}}</span>
        <button class="alert-close" (click)="dismissAlert(alert)">‚úñ</button>
      </div>
    </div>
  </div>
</div>
