<div class="admin-expenses-container">
  <div class="page-header">
    <h1>ğŸ’¸ Expense Management</h1>

    <!-- Expense Source Tabs -->
    <div class="expense-source-tabs">
      <button
        class="tab-btn"
        [class.active]="currentExpenseSource === 'Offline'"
        (click)="switchExpenseSource('Offline')">
        ğŸª Offline Expenses
      </button>
      <button
        class="tab-btn"
        [class.active]="currentExpenseSource === 'Online'"
        (click)="switchExpenseSource('Online')">
        ğŸŒ Online Expenses
      </button>
    </div>

    <div class="header-actions">
      <button class="btn-primary" (click)="openAddModal()">â• Add Expense</button>
      <button class="btn-secondary" (click)="openUploadModal()">ğŸ“¤ Upload Excel</button>
      <button class="btn-info" (click)="loadSummary()">ğŸ“Š View Summary</button>
      <button
        class="btn-secondary"
        (click)="initializeOfflineExpenseTypes()"
        *ngIf="currentExpenseSource === 'Offline' && offlineExpenseTypes.length === 0">
        ğŸ”§ Initialize Offline Types
      </button>
      <button
        class="btn-secondary"
        (click)="initializeOnlineExpenseTypes()"
        *ngIf="currentExpenseSource === 'Online' && onlineExpenseTypes.length === 0">
        ğŸ”§ Initialize Online Types
      </button>
    </div>
  </div>

  <!-- Summary Section -->
  <div *ngIf="summary" class="summary-card">
    <h2>Expense Summary - {{ formatDate(summary.date) }}</h2>
    <div class="summary-grid">
      <div class="summary-item">
        <span class="label">Total Expenses:</span>
        <span class="value">{{ formatCurrency(summary.totalExpenses) }}</span>
      </div>
    </div>
    <div class="expense-breakdown">
      <h3>Expense Type Breakdown</h3>
      <div *ngFor="let type of summary.expenseTypeBreakdown | keyvalue" class="breakdown-item">
        <span>{{ getExpenseTypeIcon(type.key) }} {{ type.key }}:</span>
        <span>{{ formatCurrency(+(type.value || 0)) }}</span>
      </div>
    </div>
    <div class="summary-date-picker">
      <label>Summary Date:</label>
      <input type="date" [(ngModel)]="summaryDate" (change)="loadSummary()">
    </div>
  </div>

  <!-- Expenses List -->
  <div class="expenses-list">
    <div *ngIf="loading" class="loading">Loading...</div>

    <div *ngIf="!loading && filteredExpenses.length === 0" class="empty-state">
      <p>No {{currentExpenseSource.toLowerCase()}} expense records found</p>
    </div>

    <div *ngFor="let expense of filteredExpenses" class="expense-card">
      <div class="expense-header">
        <div class="expense-type" [style.color]="getExpenseTypeColor(expense.expenseType)">
          {{ getExpenseTypeIcon(expense.expenseType) }} {{ expense.expenseType }}
        </div>
        <div class="expense-amount">
          {{ formatCurrency(expense.amount) }}
        </div>
      </div>

      <div class="expense-details">
        <div class="detail-row">
          <span class="label">ğŸ“… Date:</span>
          <span class="value">{{ formatDate(expense.date) }}</span>
        </div>
        <div class="detail-row">
          <span class="label">ğŸ’³ Payment:</span>
          <span class="value payment-method">{{ expense.paymentMethod }}</span>
        </div>
        <div class="detail-row">
          <span class="label">ğŸ‘¤ Recorded By:</span>
          <span class="value">{{ expense.recordedBy }}</span>
        </div>
      </div>

      <div *ngIf="expense.notes" class="expense-notes">
        <em>Note: {{ expense.notes }}</em>
      </div>

      <div class="expense-actions">
        <button class="btn-edit" (click)="openEditModal(expense)">âœï¸ Edit</button>
        <button class="btn-delete" (click)="deleteExpense(expense.id)">ğŸ—‘ï¸ Delete</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingId ? 'Edit' : 'Add' }} Expense</h2>
        <button class="btn-close" (click)="closeModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Date *</label>
            <input type="date" [(ngModel)]="formData.date" required>
          </div>

          <div class="form-group">
            <label>Expense Type *</label>
            <select [(ngModel)]="formData.expenseType" required>
              <option value="">-- Select Expense Type --</option>
              <option *ngFor="let type of currentExpenseTypes" [value]="type.expenseType">{{ type.expenseType }}</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Amount *</label>
            <input type="number" [(ngModel)]="formData.amount" min="0" step="0.01" required>
          </div>

          <div class="form-group">
            <label>Payment Method *</label>
            <select [(ngModel)]="formData.paymentMethod" required>
              <option *ngFor="let method of paymentMethods" [value]="method">{{ method }}</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea [(ngModel)]="formData.notes" rows="3" placeholder="Any additional notes..."></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn-primary" (click)="saveExpense()" [disabled]="loading">
          {{ loading ? 'Saving...' : 'Save Expense' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div *ngIf="showUploadModal" class="modal-overlay" (click)="closeUploadModal()">
    <div class="modal-content upload-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ğŸ“¤ Upload Expenses from Excel</h2>
        <button class="btn-close" (click)="closeUploadModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <div class="upload-instructions">
          <h3>Excel Format</h3>
          <p>Columns: Date, ExpenseType, Amount, PaymentMethod</p>
          <button class="btn-template" (click)="downloadTemplate()">ğŸ“¥ Download Template</button>
        </div>

        <div class="file-upload-area">
          <input type="file" id="fileInput" accept=".xlsx,.xls" (change)="onFileSelected($event)" style="display: none;">
          <label for="fileInput" class="upload-label">
            <span *ngIf="!selectedFile">ğŸ“‚ Choose Excel File</span>
            <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
          </label>
        </div>

        <div *ngIf="uploadError" class="error-message">{{ uploadError }}</div>

        <div *ngIf="uploadResult" class="success-message">
          <h3>âœ… Upload Successful!</h3>
          <p>{{ uploadResult.message }}</p>
          <ul>
            <li>Processed Records: {{ uploadResult.processedRecords }}</li>
            <li>Total Amount: {{ formatCurrency(uploadResult.totalAmount) }}</li>
          </ul>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeUploadModal()">Close</button>
        <button class="btn-primary" (click)="uploadFile()" [disabled]="!selectedFile || uploading">
          {{ uploading ? 'Uploading...' : 'Upload' }}
        </button>
      </div>
    </div>
  </div>
</div>
