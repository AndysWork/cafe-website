<div class="admin-expenses-container">
  <div class="page-header">
    <h1>ğŸ’¸ Expense Management</h1>

    <!-- Expense Source Tabs -->
    <div class="expense-source-tabs">
      <button
        class="tab-btn"
        [class.active]="currentExpenseSource === 'Offline'"
        (click)="switchExpenseSource('Offline')"
      >
        ğŸª Offline Expenses
      </button>
      <button
        class="tab-btn"
        [class.active]="currentExpenseSource === 'Online'"
        (click)="switchExpenseSource('Online')"
      >
        ğŸŒ Online Expenses
      </button>
      <button
        class="tab-btn"
        [class.active]="currentExpenseSource === 'Operational'"
        (click)="switchExpenseSource('Operational')"
      >
        ğŸ’¼ Operational Costs
      </button>
    </div>

    <div class="header-actions">
      <button
        class="btn-primary"
        (click)="
          currentExpenseSource === 'Operational'
            ? openOperationalAddModal()
            : openAddModal()
        "
      >
        â•
        {{
          currentExpenseSource === "Operational"
            ? "Add Monthly Expense"
            : "Add Expense"
        }}
      </button>
      <button
        class="btn-warning"
        (click)="openExpenseTypeModal()"
        *ngIf="currentExpenseSource !== 'Operational'"
      >
        ğŸ› ï¸ Manage Types
      </button>
      <button
        class="btn-secondary"
        (click)="openUploadModal()"
        *ngIf="currentExpenseSource !== 'Operational'"
      >
        ğŸ“¤ Upload Excel
      </button>
      <button
        class="btn-info"
        (click)="loadSummary()"
        *ngIf="currentExpenseSource !== 'Operational'"
      >
        ğŸ“Š View Summary
      </button>
      <button
        class="btn-secondary"
        (click)="initializeOfflineExpenseTypes()"
        *ngIf="
          currentExpenseSource === 'Offline' && offlineExpenseTypes.length === 0
        "
      >
        ğŸ”§ Initialize Offline Types
      </button>
      <button
        class="btn-secondary"
        (click)="initializeOnlineExpenseTypes()"
        *ngIf="
          currentExpenseSource === 'Online' && onlineExpenseTypes.length === 0
        "
      >
        ğŸ”§ Initialize Online Types
      </button>
    </div>
  </div>

  <!-- Summary Section -->
  <div
    *ngIf="summary && currentExpenseSource !== 'Operational'"
    class="summary-card"
  >
    <h2>Expense Summary - {{ formatDate(summary.date) }}</h2>
    <div class="summary-grid">
      <div class="summary-item">
        <span class="label">Total Expenses:</span>
        <span class="value">{{ formatCurrency(summary.totalExpenses) }}</span>
      </div>
    </div>
    <div class="expense-breakdown">
      <h3>Expense Type Breakdown</h3>
      <div
        *ngFor="let type of summary.expenseTypeBreakdown | keyvalue"
        class="breakdown-item"
      >
        <span>{{ getExpenseTypeIcon(type.key) }} {{ type.key }}:</span>
        <span>{{ formatCurrency(+(type.value || 0)) }}</span>
      </div>
    </div>
    <div class="summary-date-picker">
      <label>Summary Date:</label>
      <input type="date" [(ngModel)]="summaryDate" (change)="loadSummary()" />
    </div>
  </div>

  <!-- Expenses List -->
  <div class="expenses-list" *ngIf="currentExpenseSource !== 'Operational'">
    <div *ngIf="loading" class="loading">Loading...</div>

    <div *ngIf="!loading && filteredExpenses.length === 0" class="empty-state">
      <p>No {{ currentExpenseSource.toLowerCase() }} expense records found</p>
    </div>

    <!-- Year-Month Grouped View -->
    <div
      *ngIf="!loading && filteredExpenses.length > 0"
      class="grouped-expenses"
    >
      <div *ngFor="let year of getYears()" class="year-group">
        <!-- Year Header -->
        <div class="year-header" (click)="toggleYear(year)">
          <div class="year-title">
            <span class="expand-icon">{{
              isYearExpanded(year) ? "â–¼" : "â–¶"
            }}</span>
            <strong>ğŸ“… {{ year }}</strong>
            <span class="year-stats">{{ getMonths(year).length }} months</span>
          </div>
          <div class="year-total">
            {{ formatCurrency(getYearTotal(year)) }}
          </div>
        </div>

        <!-- Months Container -->
        <div *ngIf="isYearExpanded(year)" class="months-container">
          <div *ngFor="let month of getMonths(year)" class="month-group">
            <!-- Month Header -->
            <div class="month-header" (click)="toggleMonth(year, month)">
              <div class="month-title">
                <span class="expand-icon">{{
                  isMonthExpanded(year, month) ? "â–¼" : "â–¶"
                }}</span>
                <strong>{{ month }}</strong>
                <span class="month-stats"
                  >{{ getWeeks(year, month).length }} weeks</span
                >
              </div>
              <div class="month-total">
                {{ formatCurrency(getMonthTotal(year, month)) }}
              </div>
            </div>

            <!-- Weeks Container -->
            <div *ngIf="isMonthExpanded(year, month)" class="weeks-container">
              <div
                *ngFor="let week of getWeeks(year, month)"
                class="week-group"
              >
                <!-- Week Header -->
                <div
                  class="week-header"
                  (click)="toggleWeek(year, month, week)"
                >
                  <div class="week-title">
                    <span class="expand-icon">{{
                      isWeekExpanded(year, month, week) ? "â–¼" : "â–¶"
                    }}</span>
                    <strong>{{ week }}</strong>
                    <span class="week-stats"
                      >{{
                        groupedExpenses[year][month][week].length
                      }}
                      records</span
                    >
                  </div>
                  <div class="week-total">
                    {{ formatCurrency(getWeekTotal(year, month, week)) }}
                  </div>
                </div>

                <!-- Expense Cards -->
                <div
                  *ngIf="isWeekExpanded(year, month, week)"
                  class="expense-cards"
                >
                  <div
                    *ngFor="let expense of groupedExpenses[year][month][week]"
                    class="expense-card"
                  >
                    <div class="expense-header">
                      <div
                        class="expense-type"
                        [style.color]="getExpenseTypeColor(expense.expenseType)"
                      >
                        {{ getExpenseTypeIcon(expense.expenseType) }}
                        {{ expense.expenseType }}
                      </div>
                      <div class="expense-amount">
                        {{ formatCurrency(expense.amount) }}
                      </div>
                    </div>

                    <div class="expense-details">
                      <div class="detail-row">
                        <span class="label">ğŸ“… Date:</span>
                        <span class="value">{{
                          formatDate(expense.date)
                        }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="label">ğŸ’³ Payment:</span>
                        <span class="value payment-method">{{
                          expense.paymentMethod
                        }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="label">ğŸ‘¤ Recorded By:</span>
                        <span class="value">{{ expense.recordedBy }}</span>
                      </div>
                    </div>

                    <div *ngIf="expense.notes" class="expense-notes">
                      <em>Note: {{ expense.notes }}</em>
                    </div>

                    <div class="expense-actions">
                      <button class="btn-edit" (click)="openEditModal(expense)">
                        âœï¸ Edit
                      </button>
                      <button
                        class="btn-delete"
                        (click)="deleteExpense(expense.id)"
                      >
                        ğŸ—‘ï¸ Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Operational Expenses Section -->
  <div
    class="operational-expenses-section"
    *ngIf="currentExpenseSource === 'Operational'"
  >
    <div class="operational-info-banner">
      <div class="info-icon">ğŸ’¼</div>
      <div class="info-text">
        <h3>Monthly Operational Costs</h3>
        <p>Track fixed monthly expenses. Rent is auto-calculated from daily expenses. All transactions recorded as Cash.</p>
      </div>
    </div>

    <div *ngIf="loading" class="loading-spinner">
      <div class="spinner"></div>
      <p>Loading operational expenses...</p>
    </div>

    <div
      *ngIf="!loading && operationalExpenses.length === 0"
      class="empty-state-operational"
    >
      <div class="empty-icon">ğŸ“Š</div>
      <h3>No Operational Records Yet</h3>
      <p>Start tracking your monthly operational costs</p>
      <button class="btn-primary" (click)="openOperationalAddModal()">
        â• Add First Record
      </button>
    </div>

    <!-- Year Grouped View for Operational -->
    <div
      *ngIf="!loading && operationalExpenses.length > 0"
      class="operational-timeline"
    >
      <div *ngFor="let year of getOperationalYears()" class="year-section">
        <div class="year-header-bar" (click)="toggleOperationalYear(year)">
          <div class="year-left">
            <span class="expand-icon" [class.expanded]="isOperationalYearExpanded(year)">â–¶</span>
            <h2 class="year-title">{{ year }}</h2>
            <span class="year-badge">{{ groupedOperationalExpenses[year].length }} months</span>
          </div>
          <div class="year-right">
            <span class="year-total-label">Annual Total</span>
            <span class="year-total-amount">{{ formatCurrency(getOperationalYearTotal(year)) }}</span>
          </div>
        </div>

        <div *ngIf="isOperationalYearExpanded(year)" class="year-expenses">
          <div class="expense-cards-grid">
            <div
              *ngFor="let expense of groupedOperationalExpenses[year]"
              class="expense-card-modern"
            >
              <div class="card-header-modern">
                <div class="month-info">
                  <span class="month-label">{{ getMonthName(expense.month) }}</span>
                  <span class="year-label">{{ expense.year }}</span>
                </div>
                <div class="total-badge-modern">
                  {{ formatCurrency(expense.totalOperationalCost) }}
                </div>
              </div>

              <div class="card-body-modern">
                <div class="expense-grid">
                  <div class="expense-item">
                    <div class="item-label">
                      <span class="item-icon">ğŸ </span>
                      <span>Rent</span>
                      <span class="auto-badge">AUTO</span>
                    </div>
                    <div class="item-value">{{ formatCurrency(expense.rent) }}</div>
                  </div>
                  <div class="expense-item">
                    <div class="item-label">
                      <span class="item-icon">ğŸ‘¨â€ğŸ³</span>
                      <span>Cook Salary</span>
                    </div>
                    <div class="item-value">{{ formatCurrency(expense.cookSalary) }}</div>
                  </div>
                  <div class="expense-item">
                    <div class="item-label">
                      <span class="item-icon">ğŸ‘·</span>
                      <span>Helper Salary</span>
                    </div>
                    <div class="item-value">{{ formatCurrency(expense.helperSalary) }}</div>
                  </div>
                  <div class="expense-item">
                    <div class="item-label">
                      <span class="item-icon">âš¡</span>
                      <span>Electricity</span>
                    </div>
                    <div class="item-value">{{ formatCurrency(expense.electricity) }}</div>
                  </div>
                  <div class="expense-item">
                    <div class="item-label">
                      <span class="item-icon">ğŸ”§</span>
                      <span>Maintenance</span>
                    </div>
                    <div class="item-value">{{ formatCurrency(expense.machineMaintenance) }}</div>
                  </div>
                  <div class="expense-item">
                    <div class="item-label">
                      <span class="item-icon">ğŸ“</span>
                      <span>Miscellaneous</span>
                    </div>
                    <div class="item-value">{{ formatCurrency(expense.misc) }}</div>
                  </div>
                </div>

                <div *ngIf="expense.notes" class="expense-notes-modern">
                  ğŸ’­ {{ expense.notes }}
                </div>
              </div>

              <div class="card-footer-modern">
                <div class="footer-meta">
                  <span class="meta-item">ğŸ’³ {{ expense.transactionType }}</span>
                  <span class="meta-item">ğŸ‘¤ {{ expense.recordedBy }}</span>
                  <span class="meta-item">ğŸ• {{ formatDate(expense.updatedAt) }}</span>
                </div>
                <div class="footer-actions">
                  <button class="btn-action-edit" (click)="openOperationalEditModal(expense)">
                    âœï¸
                  </button>
                  <button class="btn-action-delete" (click)="deleteOperationalExpense(expense.id)">
                    ğŸ—‘ï¸
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div *ngIf="showModal" class="modal-overlay" (click)="closeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingId ? "Edit" : "Add" }} Expense</h2>
        <button class="btn-close" (click)="closeModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>Date *</label>
            <input type="date" [(ngModel)]="formData.date" required />
          </div>

          <div class="form-group">
            <label>Expense Type *</label>
            <select [(ngModel)]="formData.expenseType" required>
              <option value="">-- Select Expense Type --</option>
              <option
                *ngFor="let type of currentExpenseTypes"
                [value]="type.expenseType"
              >
                {{ type.expenseType }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Amount *</label>
            <input
              type="number"
              [(ngModel)]="formData.amount"
              min="0"
              step="0.01"
              required
            />
          </div>

          <div class="form-group">
            <label>Payment Method *</label>
            <select [(ngModel)]="formData.paymentMethod" required>
              <option *ngFor="let method of paymentMethods" [value]="method">
                {{ method }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea
            [(ngModel)]="formData.notes"
            rows="3"
            placeholder="Any additional notes..."
          ></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeModal()">Cancel</button>
        <button
          class="btn-primary"
          (click)="saveExpense()"
          [disabled]="loading"
        >
          {{ loading ? "Saving..." : "Save Expense" }}
        </button>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div
    *ngIf="showUploadModal"
    class="modal-overlay"
    (click)="closeUploadModal()"
  >
    <div class="modal-content upload-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ğŸ“¤ Upload Expenses from Excel</h2>
        <button class="btn-close" (click)="closeUploadModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <div class="upload-instructions">
          <h3>Excel Format</h3>
          <p>Columns: Date, ExpenseType, Amount, PaymentMethod</p>
          <button class="btn-template" (click)="downloadTemplate()">
            ğŸ“¥ Download Template
          </button>
        </div>

        <div class="file-upload-area">
          <input
            type="file"
            id="fileInput"
            accept=".xlsx,.xls"
            (change)="onFileSelected($event)"
            style="display: none"
          />
          <label for="fileInput" class="upload-label">
            <span *ngIf="!selectedFile">ğŸ“‚ Choose Excel File</span>
            <span *ngIf="selectedFile">{{ selectedFile.name }}</span>
          </label>
        </div>

        <div *ngIf="uploadError" class="error-message">{{ uploadError }}</div>

        <div *ngIf="uploadResult" class="success-message">
          <h3>âœ… Upload Successful!</h3>
          <p>{{ uploadResult.message }}</p>
          <ul>
            <li>Processed Records: {{ uploadResult.processedRecords }}</li>
            <li>
              Total Amount: {{ formatCurrency(uploadResult.totalAmount) }}
            </li>
          </ul>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeUploadModal()">
          Close
        </button>
        <button
          class="btn-primary"
          (click)="uploadFile()"
          [disabled]="!selectedFile || uploading"
        >
          {{ uploading ? "Uploading..." : "Upload" }}
        </button>
      </div>
    </div>
  </div>

  <!-- Operational Expense Modal -->
  <div
    *ngIf="showOperationalModal"
    class="modal-overlay"
    (click)="closeOperationalModal()"
  >
    <div
      class="modal-content operational-modal"
      (click)="$event.stopPropagation()"
    >
      <div class="modal-header">
        <h2>
          {{ isOperationalEditMode ? "Edit" : "Add" }} Monthly Operational
          Expense
        </h2>
        <button class="btn-close" (click)="closeOperationalModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <form class="operational-form">
          <!-- Month and Year Selection -->
          <div class="form-row">
            <div class="form-group">
              <label>Month *</label>
              <select
                [(ngModel)]="operationalFormData.month"
                name="month"
                [disabled]="isOperationalEditMode"
                (change)="calculateRent()"
                required
              >
                <option *ngFor="let month of months" [value]="month.value">
                  {{ month.name }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>Year *</label>
              <input
                type="number"
                [(ngModel)]="operationalFormData.year"
                name="year"
                [disabled]="isOperationalEditMode"
                (change)="calculateRent()"
                min="2020"
                max="2100"
                required
              />
            </div>
          </div>

          <!-- Calculated Rent -->
          <div class="rent-display">
            <div class="rent-label">
              ğŸ  Rent (Auto-calculated from Offline Expenses):
              <button
                type="button"
                class="btn-refresh"
                (click)="calculateRent()"
                [disabled]="calculatingRent"
              >
                {{ calculatingRent ? "â³" : "ğŸ”„" }} Refresh
              </button>
            </div>
            <div class="rent-value">{{ formatCurrency(calculatedRent) }}</div>
          </div>

          <!-- Salary Fields -->
          <div class="form-section">
            <h3>ğŸ’° Salaries</h3>
            <div class="form-row">
              <div class="form-group">
                <label>ğŸ‘¨â€ğŸ³ Cook Salary</label>
                <input
                  type="number"
                  [(ngModel)]="operationalFormData.cookSalary"
                  name="cookSalary"
                  min="0"
                  step="100"
                />
              </div>
              <div class="form-group">
                <label>ğŸ‘· Helper Salary</label>
                <input
                  type="number"
                  [(ngModel)]="operationalFormData.helperSalary"
                  name="helperSalary"
                  min="0"
                  step="100"
                />
              </div>
            </div>
          </div>

          <!-- Utility and Maintenance Fields -->
          <div class="form-section">
            <h3>ğŸ”§ Utilities & Maintenance</h3>
            <div class="form-row">
              <div class="form-group">
                <label>âš¡ Electricity</label>
                <input
                  type="number"
                  [(ngModel)]="operationalFormData.electricity"
                  name="electricity"
                  min="0"
                  step="50"
                />
              </div>
              <div class="form-group">
                <label>ğŸ”§ Machine Maintenance</label>
                <input
                  type="number"
                  [(ngModel)]="operationalFormData.machineMaintenance"
                  name="machineMaintenance"
                  min="0"
                  step="50"
                />
              </div>
            </div>
          </div>

          <!-- Miscellaneous -->
          <div class="form-group">
            <label>ğŸ“ Miscellaneous</label>
            <input
              type="number"
              [(ngModel)]="operationalFormData.misc"
              name="misc"
              min="0"
              step="50"
            />
          </div>

          <!-- Notes -->
          <div class="form-group">
            <label>ğŸ“‹ Notes</label>
            <textarea
              [(ngModel)]="operationalFormData.notes"
              name="notes"
              rows="3"
              placeholder="Additional notes about this month's operational expenses..."
            ></textarea>
          </div>

          <!-- Total Display -->
          <div class="total-display">
            <div class="total-label">ğŸ’¼ Total Operational Cost:</div>
            <div class="total-value">
              {{ formatCurrency(getTotalOperationalCost()) }}
            </div>
          </div>

          <div class="info-note">
            <strong>Note:</strong> Transaction type is automatically set to
            <strong>Cash</strong> for all operational expenses.
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeOperationalModal()">
          Cancel
        </button>
        <button
          class="btn-primary"
          (click)="saveOperationalExpense()"
          [disabled]="loading"
        >
          {{
            loading ? "Saving..." : isOperationalEditMode ? "Update" : "Create"
          }}
        </button>
      </div>
    </div>
  </div>

  <!-- Expense Type Management Modal -->
  <div *ngIf="showExpenseTypeModal" class="modal-overlay" (click)="closeExpenseTypeModal()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ğŸ› ï¸ Manage {{ currentExpenseSource }} Expense Types</h2>
        <button class="btn-close" (click)="closeExpenseTypeModal()">Ã—</button>
      </div>

      <div class="modal-body">
        <!-- Add/Edit Form -->
        <div class="expense-type-form">
          <h3>{{ editingExpenseType ? 'Edit' : 'Add New' }} Expense Type</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Expense Type Name *</label>
              <input type="text" [(ngModel)]="expenseTypeForm.expenseType" placeholder="e.g., Milk, Sugar" required>
            </div>
            <div class="form-actions">
              <button class="btn-primary" (click)="saveExpenseType()" [disabled]="loading">
                {{ editingExpenseType ? 'ğŸ’¾ Update' : 'â• Add' }}
              </button>
              <button *ngIf="editingExpenseType" class="btn-secondary" (click)="closeEditExpenseType()">Cancel Edit</button>
            </div>
          </div>
        </div>

        <!-- Types List -->
        <div class="expense-types-list">
          <h3>Existing {{ currentExpenseSource }} Expense Types ({{ currentExpenseTypes.length }})</h3>
          <div class="types-grid">
            <div *ngFor="let type of currentExpenseTypes" class="expense-type-card">
              <div class="type-info">
                <strong>{{ type.expenseType }}</strong>
                <span class="status-badge" [class.inactive]="!type.isActive">
                  {{ type.isActive ? 'âœ… Active' : 'âŒ Inactive' }}
                </span>
              </div>
              <div class="type-actions">
                <button class="btn-edit-small" (click)="openEditExpenseType(type)" title="Edit">âœï¸</button>
                <button class="btn-delete-small" (click)="deleteExpenseType(type)" title="Delete">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>
          <div *ngIf="currentExpenseTypes.length === 0" class="empty-state">
            <p>No expense types found. Add your first expense type above or use the Initialize button.</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeExpenseTypeModal()">Close</button>
      </div>
    </div>
  </div>
</div>
