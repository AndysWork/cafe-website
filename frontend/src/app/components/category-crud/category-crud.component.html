<div class="crud-container">
  <div class="crud-header">
    <div class="header-content">
      <h1>Category Management</h1>
      <p>Create, update, and delete categories and subcategories</p>
    </div>
    <button class="btn-upload" (click)="openUploadModal()">
      <span class="icon">ğŸ“¤</span>
      Upload File
    </button>
  </div>

  <!-- Message Alert -->
  <div class="alert" *ngIf="message.text" [class.success]="message.type === 'success'" [class.error]="message.type === 'error'">
    {{ message.text }}
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab" [class.active]="selectedTab === 'categories'" (click)="selectedTab = 'categories'">
      ğŸ“ Categories
    </button>
    <button class="tab" [class.active]="selectedTab === 'subcategories'" (click)="selectedTab = 'subcategories'">
      ğŸ“‚ SubCategories
    </button>
  </div>

  <!-- Categories Tab -->
  <div class="tab-content" *ngIf="selectedTab === 'categories'">
    <!-- Create Category Form -->
    <div class="create-form">
      <h2>Create New Category</h2>
      <div class="form-group">
        <input
          type="text"
          [(ngModel)]="newCategory"
          placeholder="Enter category name"
          class="form-input"
          (keyup.enter)="createCategory()">
        <button
          class="btn btn-primary"
          (click)="createCategory()"
          [disabled]="loading.saving">
          {{ loading.saving ? 'Creating...' : 'Create Category' }}
        </button>
      </div>
    </div>

    <!-- Categories Table -->
    <div class="table-container">
      <h2>All Categories ({{ categories.length }})</h2>

      <div class="loading" *ngIf="loading.categories">
        <div class="spinner"></div>
        <p>Loading categories...</p>
      </div>

      <table class="data-table" *ngIf="!loading.categories && categories.length > 0">
        <thead>
          <tr>
            <th>Name</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let category of categories" [class.editing]="category.isEditing">
            <td>
              <span *ngIf="!category.isEditing">{{ category.name }}</span>
              <input
                *ngIf="category.isEditing"
                type="text"
                [(ngModel)]="editingCategory!.name"
                class="edit-input">
            </td>
            <td class="actions">
              <div *ngIf="!category.isEditing">
                <button class="btn btn-edit" (click)="startEdit(category, 'category')">
                  âœï¸ Edit
                </button>
                <button class="btn btn-delete" (click)="deleteCategory(category)" [disabled]="loading.deleting">
                  ğŸ—‘ï¸ Delete
                </button>
              </div>
              <div *ngIf="category.isEditing">
                <button class="btn btn-save" (click)="saveCategory(category)" [disabled]="loading.saving">
                  âœ“ Save
                </button>
                <button class="btn btn-cancel" (click)="cancelEdit(category)">
                  âœ— Cancel
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="empty-state" *ngIf="!loading.categories && categories.length === 0">
        <span class="empty-icon">ğŸ“</span>
        <p>No categories found</p>
        <p class="empty-hint">Create your first category above</p>
      </div>
    </div>
  </div>

  <!-- SubCategories Tab -->
  <div class="tab-content" *ngIf="selectedTab === 'subcategories'">
    <!-- Create SubCategory Form -->
    <div class="create-form">
      <h2>Create New SubCategory</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Category</label>
          <select
            [(ngModel)]="newSubCategory.categoryId"
            class="form-select">
            <option value="">Select a category</option>
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>
        <div class="form-group">
          <label>SubCategory Name</label>
          <input
            type="text"
            [(ngModel)]="newSubCategory.name"
            placeholder="Enter subcategory name"
            class="form-input"
            (keyup.enter)="createSubCategory()">
        </div>
        <button
          class="btn btn-primary"
          (click)="createSubCategory()"
          [disabled]="loading.saving">
          {{ loading.saving ? 'Creating...' : 'Create SubCategory' }}
        </button>
      </div>
    </div>

    <!-- Filter -->
    <div class="filter-section">
      <h2>Filter by Category</h2>
      <select
        [(ngModel)]="selectedCategoryId"
        (change)="filterSubCategories()"
        class="form-select">
        <option value="">All Categories</option>
        <option *ngFor="let category of categories" [value]="category.id">
          {{ category.name }}
        </option>
      </select>
    </div>

    <!-- SubCategories Table -->
    <div class="table-container">
      <h2>All SubCategories ({{ filteredSubCategories.length }})</h2>

      <div class="loading" *ngIf="loading.subCategories">
        <div class="spinner"></div>
        <p>Loading subcategories...</p>
      </div>

      <table class="data-table" *ngIf="!loading.subCategories && filteredSubCategories.length > 0">
        <thead>
          <tr>
            <th>Category</th>
            <th>SubCategory Name</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let subCategory of filteredSubCategories" [class.editing]="subCategory.isEditing">
            <td>
              <span *ngIf="!subCategory.isEditing">{{ getCategoryName(subCategory.categoryId) }}</span>
              <select
                *ngIf="subCategory.isEditing"
                [(ngModel)]="editingSubCategory!.categoryId"
                class="edit-select">
                <option *ngFor="let category of categories" [value]="category.id">
                  {{ category.name }}
                </option>
              </select>
            </td>
            <td>
              <span *ngIf="!subCategory.isEditing">{{ subCategory.name }}</span>
              <input
                *ngIf="subCategory.isEditing"
                type="text"
                [(ngModel)]="editingSubCategory!.name"
                class="edit-input">
            </td>
            <td class="actions">
              <div *ngIf="!subCategory.isEditing">
                <button class="btn btn-edit" (click)="startEdit(subCategory, 'subcategory')">
                  âœï¸ Edit
                </button>
                <button class="btn btn-delete" (click)="deleteSubCategory(subCategory)" [disabled]="loading.deleting">
                  ğŸ—‘ï¸ Delete
                </button>
              </div>
              <div *ngIf="subCategory.isEditing">
                <button class="btn btn-save" (click)="saveSubCategory(subCategory)" [disabled]="loading.saving">
                  âœ“ Save
                </button>
                <button class="btn btn-cancel" (click)="cancelEdit(subCategory)">
                  âœ— Cancel
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="empty-state" *ngIf="!loading.subCategories && filteredSubCategories.length === 0">
        <span class="empty-icon">ğŸ“‚</span>
        <p>No subcategories found</p>
        <p class="empty-hint">Create your first subcategory above</p>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal-overlay" *ngIf="showUploadModal" (click)="closeUploadModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>ğŸ“¤ Upload Categories & Subcategories</h2>
        <button class="btn-close" (click)="closeUploadModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <!-- Instructions -->
        <div class="upload-instructions">
          <h3>ğŸ“‹ File Format</h3>
          <p>Upload an Excel (.xlsx, .xls) or CSV file with the following columns:</p>
          <div class="column-tags">
            <span class="column-tag">Category</span>
            <span class="column-tag">SubCategory</span>
          </div>
          <div class="template-buttons">
            <button class="btn-template" (click)="downloadTemplate('excel')">
              <span class="icon">ğŸ“Š</span>
              Download Excel Template
            </button>
            <button class="btn-template" (click)="downloadTemplate('csv')">
              <span class="icon">ğŸ“„</span>
              Download CSV Template
            </button>
          </div>
        </div>

        <!-- Upload Area -->
        <div class="upload-area"
             [class.drag-over]="isDragging"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (drop)="onDrop($event)">

          <div *ngIf="!selectedFile" class="upload-prompt">
            <div class="upload-icon">ğŸ“</div>
            <h3>Drag & Drop File Here</h3>
            <p>or</p>
            <label for="categoryFileInput" class="btn-select-file">
              <span class="icon">ğŸ“‚</span>
              Browse Files
            </label>
            <input
              type="file"
              id="categoryFileInput"
              accept=".xlsx,.xls,.csv"
              (change)="onFileSelected($event)"
              style="display: none;">
            <p class="file-info">Supported formats: .xlsx, .xls, .csv (Max 5MB)</p>
          </div>

          <div *ngIf="selectedFile" class="file-selected">
            <div class="file-icon">{{ getFileIcon() }}</div>
            <div class="file-details">
              <h4>{{ selectedFile.name }}</h4>
              <p>{{ formatFileSize(selectedFile.size) }}</p>
            </div>
            <button class="btn-remove" (click)="clearFile()" [disabled]="isUploading">
              âœ•
            </button>
          </div>
        </div>

        <!-- Upload Progress -->
        <div class="upload-progress" *ngIf="isUploading">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="uploadProgress"></div>
          </div>
          <p class="progress-text">Uploading... {{ uploadProgress }}%</p>
        </div>

        <!-- Upload Button -->
        <div class="upload-actions" *ngIf="selectedFile && !isUploading">
          <button class="btn-upload-file" (click)="uploadFile()">
            <span class="icon">ğŸš€</span>
            Upload File
          </button>
        </div>

        <!-- Error Message -->
        <div class="error-message" *ngIf="uploadError">
          <span class="error-icon">âš ï¸</span>
          <p>{{ uploadError }}</p>
        </div>

        <!-- Upload Result -->
        <div class="upload-result" *ngIf="uploadResult">
          <div class="result-success" *ngIf="uploadResult.Success">
            <span class="success-icon">âœ…</span>
            <h3>Upload Successful!</h3>
          </div>
          <p class="result-message">{{ uploadResult.Message }}</p>
          <div class="result-stats">
            <div class="stat">
              <strong>{{ uploadResult.CategoriesProcessed }}</strong>
              <span>Categories</span>
            </div>
            <div class="stat">
              <strong>{{ uploadResult.SubCategoriesProcessed }}</strong>
              <span>Subcategories</span>
            </div>
          </div>
          <div class="errors-section" *ngIf="uploadResult.Errors && uploadResult.Errors.length > 0">
            <h4>âš ï¸ Errors ({{ uploadResult.Errors.length }})</h4>
            <div class="error-list">
              <div class="error-item" *ngFor="let err of uploadResult.Errors">
                {{ err }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeUploadModal()">Close</button>
      </div>
    </div>
  </div>
</div>
