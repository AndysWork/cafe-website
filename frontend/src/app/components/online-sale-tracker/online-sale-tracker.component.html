<div class="online-sale-tracker">
  <div class="header">
    <h1>üì± Online Sales Tracker</h1>
    <p class="subtitle">Track Zomato & Swiggy Orders</p>
  </div>

  <!-- Platform Selection & Upload -->
  <div class="upload-section card">
    <div class="platform-selector">
      <label>
        <input
          type="radio"
          name="platform"
          value="Zomato"
          [(ngModel)]="selectedPlatform"
          (change)="onPlatformChange()"
        />
        <span class="platform-label zomato">üçî Zomato</span>
      </label>
      <label>
        <input
          type="radio"
          name="platform"
          value="Swiggy"
          [(ngModel)]="selectedPlatform"
          (change)="onPlatformChange()"
        />
        <span class="platform-label swiggy">üçï Swiggy</span>
      </label>
    </div>

    <div class="upload-controls">
      <input
        type="file"
        id="fileInput"
        accept=".xlsx,.xls"
        (change)="onFileSelected($event)"
        class="file-input"
      />
      <button
        (click)="uploadFile()"
        [disabled]="!selectedFile || isUploading || isDeleting"
        class="btn btn-primary upload-btn"
      >
        <span *ngIf="!isUploading">üì§ Upload {{ selectedPlatform }} Excel</span>
        <span *ngIf="isUploading">‚è≥ Uploading...</span>
      </button>
      <button
        (click)="deleteSalesData()"
        [disabled]="isUploading || isDeleting || sales.length === 0"
        class="btn btn-danger delete-btn"
        title="Delete all {{ selectedPlatform }} sales in the selected date range"
      >
        <span *ngIf="!isDeleting">üóëÔ∏è Clear Data</span>
        <span *ngIf="isDeleting">‚è≥ Deleting...</span>
      </button>
    </div>

    <div *ngIf="uploadMessage" [class]="uploadSuccess ? 'message success' : 'message error'">
      <pre class="upload-details">{{ uploadMessage }}</pre>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-label">ÔøΩ Total Orders</div>
      <div class="stat-value">{{ totalOrders }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üõí Item Subtotal</div>
      <div class="stat-value">{{ formatCurrency(itemSubtotal) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üì¶ Packaging Charge</div>
      <div class="stat-value">{{ formatCurrency(packagingCharge) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üé´ Total Discount</div>
      <div class="stat-value">{{ formatCurrency(totalDiscount) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üéÅ Total Freebies</div>
      <div class="stat-value">{{ formatCurrency(totalFreebies) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üìä Total Deduction</div>
      <div class="stat-value">{{ formatCurrency(totalDeduction) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üè¶ Total Monthly Charges</div>
      <div class="stat-value">{{ formatCurrency(totalMonthlyCharges) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üí∞ Net Payout</div>
      <div class="stat-value">{{ formatCurrency(totalPayout) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">‚≠ê Average Rating</div>
      <div class="stat-value">{{ averageRating.toFixed(1) }} ‚≠ê</div>
    </div>
  </div>

  <!-- Date Range Filter -->
  <div class="filters-section card">
    <div class="filter-group">
      <label for="startDate">Start Date:</label>
      <input
        type="date"
        id="startDate"
        [(ngModel)]="startDate"
        (change)="onDateRangeChange()"
        class="date-input"
      />
    </div>
    <div class="filter-group">
      <label for="endDate">End Date:</label>
      <input
        type="date"
        id="endDate"
        [(ngModel)]="endDate"
        (change)="onDateRangeChange()"
        class="date-input"
      />
    </div>
    <button (click)="exportToCSV()" class="btn btn-secondary export-btn">
      üìä Export to CSV
    </button>
    <button (click)="toggleDeleteSection()" class="btn btn-danger export-btn">
      üóëÔ∏è Delete Sales
    </button>
  </div>

  <!-- Delete Sales by Date Range Section -->
  <div *ngIf="showDeleteSection" class="delete-section card">
    <h3>‚ö†Ô∏è Delete Sales by Date Range</h3>
    <p class="warning-text">This will permanently delete sales data. This action cannot be undone!</p>

    <div class="delete-form">
      <div class="filter-group">
        <label for="deleteStartDate">Delete From:</label>
        <input
          type="date"
          id="deleteStartDate"
          [(ngModel)]="deleteStartDate"
          class="date-input"
        />
      </div>
      <div class="filter-group">
        <label for="deleteEndDate">Delete To:</label>
        <input
          type="date"
          id="deleteEndDate"
          [(ngModel)]="deleteEndDate"
          class="date-input"
        />
      </div>
      <div class="filter-group">
        <label>Platform:</label>
        <span class="platform-badge">{{ selectedPlatform }}</span>
      </div>
    </div>

    <div class="delete-actions">
      <button
        (click)="deleteSalesByDateRange()"
        class="btn btn-danger"
        [disabled]="isDeleting"
      >
        {{ isDeleting ? 'Deleting...' : 'Delete Sales' }}
      </button>
      <button
        (click)="toggleDeleteSection()"
        class="btn btn-secondary"
        [disabled]="isDeleting"
      >
        Cancel
      </button>
    </div>

    <div *ngIf="deleteMessage"
         class="upload-message"
         [class.success]="deleteSuccess"
         [class.error]="!deleteSuccess">
      {{ deleteMessage }}
    </div>
  </div>

  <!-- Platform Charges Section -->
  <div class="platform-charges-section card">
    <div class="section-header" (click)="togglePlatformCharges()">
      <h2>üí≥ Monthly Platform Charges - {{ selectedPlatform }}</h2>
      <div class="header-actions">
        <button (click)="openAddChargeModal(); $event.stopPropagation()" class="btn btn-primary">
          ‚ûï Add Charge
        </button>
        <span class="toggle-icon">{{ showPlatformCharges ? '‚ñº' : '‚ñ∂' }}</span>
      </div>
    </div>
    <div *ngIf="showPlatformCharges" class="charges-container">
      <div *ngIf="getChargesByPlatform().length === 0" class="empty-state-small">
        <p>No charges recorded for {{ selectedPlatform }}</p>
      </div>
      <div class="charges-grid">
        <div *ngFor="let charge of getChargesByPlatform()" class="charge-card">
          <div class="charge-header">
            <div class="charge-month">
              <span class="month-icon">üìÖ</span>
              <span class="month-text">{{ getMonthName(charge.month) }} {{ charge.year }}</span>
            </div>
            <div class="charge-amount">
              {{ formatCurrency(charge.charges) }}
            </div>
          </div>
          <div class="charge-details">
            <div *ngIf="charge.chargeType" class="charge-type">
              <strong>Type:</strong> {{ charge.chargeType }}
            </div>
            <div *ngIf="charge.notes" class="charge-notes">
              <strong>Notes:</strong> {{ charge.notes }}
            </div>
            <div class="charge-meta">
              <span>üë§ {{ charge.recordedBy }}</span>
            </div>
          </div>
          <div class="charge-actions">
            <button class="btn-edit" (click)="openEditChargeModal(charge)">
              ‚úèÔ∏è Edit
            </button>
            <button class="btn-delete" (click)="deletePlatformCharge(charge.id!)">
              üóëÔ∏è Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Loading sales data...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-banner">
    {{ errorMessage }}
  </div>

  <!-- Daily Income Table -->
  <div class="daily-income-section card" *ngIf="!isLoading && dailyIncome.length > 0">
    <div class="section-header" (click)="toggleDailyIncome()">
      <h2>üìÖ Daily Income Summary</h2>
      <span class="toggle-icon">{{ showDailyIncome ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="cascading-container" *ngIf="showDailyIncome">
      <div *ngFor="let monthGroup of getGroupedDailyIncome() | keyvalue" class="month-group">
        <div class="month-header" (click)="toggleMonth(monthGroup.key)">
          <div class="month-title">
            <span class="toggle-icon-small">{{ isMonthCollapsed(monthGroup.key) ? '‚ñ∂' : '‚ñº' }}</span>
            <h3>{{ monthGroup.key }}</h3>
          </div>
          <div class="month-summary">
            <span class="summary-item">
              <strong>Orders:</strong> {{ getMonthTotal(monthGroup.value, 'totalOrders') }}
            </span>
            <span class="summary-item">
              <strong>Income (Payout):</strong> {{ formatCurrency(getMonthTotal(monthGroup.value, 'totalPayout')) }}
            </span>
            <span class="summary-item">
              <strong>Deduction (Track):</strong> {{ formatCurrency(getMonthTotal(monthGroup.value, 'totalDeduction')) }}
            </span>
            <span class="summary-item">
              <strong>Discount:</strong> {{ formatCurrency(getMonthTotal(monthGroup.value, 'totalDiscount')) }}
            </span>
            <span class="summary-item">
              <strong>Packaging:</strong> {{ formatCurrency(getMonthTotal(monthGroup.value, 'totalPackaging')) }}
            </span>
          </div>
        </div>
        <div class="month-content" *ngIf="!isMonthCollapsed(monthGroup.key)">
          <table class="income-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Platform</th>
                <th>Orders</th>
                <th>Income (Payout)</th>
                <th>Deduction (Track)</th>
                <th>Discount</th>
                <th>Packaging</th>
                <th>Avg Rating</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let income of monthGroup.value" [class.zomato-row]="income.platform === 'Zomato'" [class.swiggy-row]="income.platform === 'Swiggy'">
                <td class="date-cell">{{ formatDate(income.date) }}</td>
                <td>
                  <span [class]="'platform-badge ' + income.platform.toLowerCase()">
                    {{ income.platform }}
                  </span>
                </td>
                <td class="text-center"><strong>{{ income.totalOrders }}</strong></td>
                <td class="amount positive"><strong>{{ formatCurrency(income.totalPayout) }}</strong></td>
                <td class="amount track-only">{{ formatCurrency(income.totalDeduction) }}</td>
                <td class="amount discount-amount">{{ formatCurrency(income.totalDiscount || 0) }}</td>
                <td class="amount packaging-amount">{{ formatCurrency(income.totalPackaging || 0) }}</td>
                <td class="text-center">{{ income.averageRating > 0 ? income.averageRating.toFixed(1) + ' ‚≠ê' : 'N/A' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Sales Details Table -->
  <div class="sales-section card" *ngIf="!isLoading && sales.length > 0">
    <div class="section-header" (click)="toggleOrderDetails()">
      <h2>üßæ Order Details ({{ sales.length }} orders)</h2>
      <span class="toggle-icon">{{ showOrderDetails ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="table-container" *ngIf="showOrderDetails">
      <div class="pagination-info">
        Showing {{ (currentPage - 1) * ordersPerPage + 1 }} - {{ Math.min(currentPage * ordersPerPage, sales.length) }} of {{ sales.length }} orders
      </div>
      <table class="sales-table">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Platform</th>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Distance</th>
            <th>Bill Total</th>
            <th>Discount</th>
            <th>Packaging</th>
            <th>Net Payout</th>
            <th>Deduction (Track)</th>
            <th>Rating</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let sale of paginatedSales" [class.zomato-row]="sale.platform === 'Zomato'" [class.swiggy-row]="sale.platform === 'Swiggy'">
            <td class="date-cell">{{ formatDate(sale.orderAt) }}</td>
            <td>
              <span [class]="'platform-badge ' + sale.platform.toLowerCase()">
                {{ sale.platform }}
              </span>
            </td>
            <td class="order-id">{{ sale.orderId }}</td>
            <td class="customer-cell">
              <div class="customer-name-wrapper" *ngIf="editingCustomerNameId !== (sale._id || sale.id)">
                <span class="customer-name">{{ sale.customerName || 'N/A' }}</span>
                <button class="btn-icon edit-icon" (click)="startEditingCustomerName(sale)" title="Edit customer name">
                  ‚úèÔ∏è
                </button>
              </div>
              <div class="customer-edit-wrapper" *ngIf="editingCustomerNameId === (sale._id || sale.id)">
                <input
                  type="text"
                  class="customer-input"
                  [(ngModel)]="editingCustomerNameValue"
                  (keyup.enter)="saveCustomerName(sale)"
                  (keyup.escape)="cancelEditingCustomerName()"
                  placeholder="Enter customer name"
                />
                <button class="btn-icon save-icon" (click)="saveCustomerName(sale)" title="Save">
                  ‚úÖ
                </button>
                <button class="btn-icon cancel-icon" (click)="cancelEditingCustomerName()" title="Cancel">
                  ‚ùå
                </button>
              </div>
            </td>
            <td>
              <span class="items-preview" [title]="formatOrderedItems(sale.orderedItems)">
                {{ getTotalItemsCount(sale.orderedItems) }} items
              </span>
            </td>
            <td class="text-center">{{ sale.distance }} km</td>
            <td class="amount">{{ formatCurrency(sale.billSubTotal) }}</td>
            <td class="amount discount-amount">{{ formatCurrency(sale.discountAmount || 0) }}</td>
            <td class="amount packaging-amount">{{ formatCurrency(sale.packagingCharges || 0) }}</td>
            <td class="amount income-highlight"><strong>{{ formatCurrency(calculateOrderNetPayout(sale)) }}</strong></td>
            <td class="amount track-only">{{ formatCurrency(sale.platformDeduction) }}</td>
            <td class="text-center">
              <span *ngIf="sale.rating" class="rating">{{ sale.rating }} ‚≠ê</span>
              <span *ngIf="!sale.rating" class="no-rating">N/A</span>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination Controls -->
      <div class="pagination-controls" *ngIf="totalPages > 1">
        <button class="btn btn-pagination" (click)="previousPage()" [disabled]="currentPage === 1">
          ‚Üê Previous
        </button>
        <div class="page-numbers">
          <button
            *ngFor="let page of [].constructor(totalPages); let i = index"
            class="btn btn-page"
            [class.active]="currentPage === i + 1"
            (click)="goToPage(i + 1)"
            [style.display]="Math.abs(currentPage - (i + 1)) <= 2 || i === 0 || i === totalPages - 1 ? 'inline-block' : 'none'"
          >
            {{ i + 1 }}
          </button>
        </div>
        <button class="btn btn-pagination" (click)="nextPage()" [disabled]="currentPage === totalPages">
          Next ‚Üí
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && sales.length === 0" class="empty-state card">
    <div class="empty-icon">üì¶</div>
    <h3>No Sales Data Available</h3>
    <p>Upload an Excel file for {{ selectedPlatform }} to get started</p>
  </div>

  <!-- Platform Charge Modal -->
  <div *ngIf="showChargeModal" class="modal-overlay" (click)="closeChargeModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditingCharge ? 'Edit' : 'Add' }} Platform Charge</h2>
        <button class="btn-close" (click)="closeChargeModal()">√ó</button>
      </div>

      <div class="modal-body">
        <form class="charge-form">
          <div class="form-row">
            <div class="form-group">
              <label>Platform *</label>
              <select
                [(ngModel)]="chargeFormData.platform"
                name="platform"
                [disabled]="isEditingCharge"
                required
              >
                <option value="Zomato">Zomato</option>
                <option value="Swiggy">Swiggy</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Month *</label>
              <select
                [(ngModel)]="chargeFormData.month"
                name="month"
                [disabled]="isEditingCharge"
                required
              >
                <option *ngFor="let month of months" [value]="month.value">
                  {{ month.name }}
                </option>
              </select>
            </div>
            <div class="form-group">
              <label>Year *</label>
              <input
                type="number"
                [(ngModel)]="chargeFormData.year"
                name="year"
                [disabled]="isEditingCharge"
                min="2020"
                max="2100"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label>Charges Amount (‚Çπ) *</label>
            <input
              type="number"
              [(ngModel)]="chargeFormData.charges"
              name="charges"
              min="0"
              step="0.01"
              required
            />
          </div>

          <div class="form-group">
            <label>Charge Type</label>
            <input
              type="text"
              [(ngModel)]="chargeFormData.chargeType"
              name="chargeType"
              placeholder="e.g., Commission, Subscription, Penalty"
            />
          </div>

          <div class="form-group">
            <label>Notes</label>
            <textarea
              [(ngModel)]="chargeFormData.notes"
              name="notes"
              rows="3"
              placeholder="Additional notes about this charge..."
            ></textarea>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeChargeModal()">
          Cancel
        </button>
        <button class="btn btn-primary" (click)="savePlatformCharge()">
          {{ isEditingCharge ? 'Update' : 'Create' }}
        </button>
      </div>
    </div>
  </div>
</div>
