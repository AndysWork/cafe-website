<div class="online-sale-tracker">
  <div class="header">
    <h1>üì± Online Sales Tracker</h1>
    <p class="subtitle">Track Zomato & Swiggy Orders</p>
  </div>

  <!-- Platform Selection & Upload -->
  <div class="upload-section card">
    <div class="platform-selector">
      <label>
        <input
          type="radio"
          name="platform"
          value="Zomato"
          [(ngModel)]="selectedPlatform"
          (change)="onPlatformChange()"
        />
        <span class="platform-label zomato">üçî Zomato</span>
      </label>
      <label>
        <input
          type="radio"
          name="platform"
          value="Swiggy"
          [(ngModel)]="selectedPlatform"
          (change)="onPlatformChange()"
        />
        <span class="platform-label swiggy">üçï Swiggy</span>
      </label>
    </div>

    <div class="upload-controls">
      <input
        type="file"
        id="fileInput"
        accept=".xlsx,.xls"
        (change)="onFileSelected($event)"
        class="file-input"
      />
      <button
        (click)="uploadFile()"
        [disabled]="!selectedFile || isUploading || isDeleting"
        class="btn btn-primary upload-btn"
      >
        <span *ngIf="!isUploading">üì§ Upload {{ selectedPlatform }} Excel</span>
        <span *ngIf="isUploading">‚è≥ Uploading...</span>
      </button>
      <button
        (click)="deleteSalesData()"
        [disabled]="isUploading || isDeleting || sales.length === 0"
        class="btn btn-danger delete-btn"
        title="Delete all {{ selectedPlatform }} sales in the selected date range"
      >
        <span *ngIf="!isDeleting">üóëÔ∏è Clear Data</span>
        <span *ngIf="isDeleting">‚è≥ Deleting...</span>
      </button>
    </div>

    <div *ngIf="uploadMessage" [class]="uploadSuccess ? 'message success' : 'message error'">
      <pre class="upload-details">{{ uploadMessage }}</pre>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-label">üí∞ Total Income (Payout)</div>
      <div class="stat-value">{{ formatCurrency(totalPayout) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üì¶ Total Orders</div>
      <div class="stat-value">{{ totalOrders }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">üìä Deduction (Track Only)</div>
      <div class="stat-value">{{ formatCurrency(totalDeduction) }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">‚≠ê Average Rating</div>
      <div class="stat-value">{{ averageRating.toFixed(1) }} ‚≠ê</div>
    </div>
  </div>

  <!-- Date Range Filter -->
  <div class="filters-section card">
    <div class="filter-group">
      <label for="startDate">Start Date:</label>
      <input
        type="date"
        id="startDate"
        [(ngModel)]="startDate"
        (change)="onDateRangeChange()"
        class="date-input"
      />
    </div>
    <div class="filter-group">
      <label for="endDate">End Date:</label>
      <input
        type="date"
        id="endDate"
        [(ngModel)]="endDate"
        (change)="onDateRangeChange()"
        class="date-input"
      />
    </div>
    <button (click)="exportToCSV()" class="btn btn-secondary export-btn">
      üìä Export to CSV
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Loading sales data...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-banner">
    {{ errorMessage }}
  </div>

  <!-- Daily Income Table -->
  <div class="daily-income-section card" *ngIf="!isLoading && dailyIncome.length > 0">
    <div class="section-header" (click)="toggleDailyIncome()">
      <h2>üìÖ Daily Income Summary</h2>
      <span class="toggle-icon">{{ showDailyIncome ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="cascading-container" *ngIf="showDailyIncome">
      <div *ngFor="let monthGroup of getGroupedDailyIncome() | keyvalue" class="month-group">
        <div class="month-header" (click)="toggleMonth(monthGroup.key)">
          <div class="month-title">
            <span class="toggle-icon-small">{{ isMonthCollapsed(monthGroup.key) ? '‚ñ∂' : '‚ñº' }}</span>
            <h3>{{ monthGroup.key }}</h3>
          </div>
          <div class="month-summary">
            <span class="summary-item">
              <strong>Orders:</strong> {{ getMonthTotal(monthGroup.value, 'totalOrders') }}
            </span>
            <span class="summary-item">
              <strong>Income (Payout):</strong> {{ formatCurrency(getMonthTotal(monthGroup.value, 'totalPayout')) }}
            </span>
            <span class="summary-item">
              <strong>Deduction (Track):</strong> {{ formatCurrency(getMonthTotal(monthGroup.value, 'totalDeduction')) }}
            </span>
            <span class="summary-item">
              <strong>Discount:</strong> {{ formatCurrency(getMonthTotal(monthGroup.value, 'totalDiscount')) }}
            </span>
            <span class="summary-item">
              <strong>Packaging:</strong> {{ formatCurrency(getMonthTotal(monthGroup.value, 'totalPackaging')) }}
            </span>
          </div>
        </div>
        <div class="month-content" *ngIf="!isMonthCollapsed(monthGroup.key)">
          <table class="income-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Platform</th>
                <th>Orders</th>
                <th>Income (Payout)</th>
                <th>Deduction (Track)</th>
                <th>Discount</th>
                <th>Packaging</th>
                <th>Avg Rating</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let income of monthGroup.value" [class.zomato-row]="income.platform === 'Zomato'" [class.swiggy-row]="income.platform === 'Swiggy'">
                <td class="date-cell">{{ formatDate(income.date) }}</td>
                <td>
                  <span [class]="'platform-badge ' + income.platform.toLowerCase()">
                    {{ income.platform }}
                  </span>
                </td>
                <td class="text-center"><strong>{{ income.totalOrders }}</strong></td>
                <td class="amount positive"><strong>{{ formatCurrency(income.totalPayout) }}</strong></td>
                <td class="amount track-only">{{ formatCurrency(income.totalDeduction) }}</td>
                <td class="amount discount-amount">{{ formatCurrency(income.totalDiscount || 0) }}</td>
                <td class="amount packaging-amount">{{ formatCurrency(income.totalPackaging || 0) }}</td>
                <td class="text-center">{{ income.averageRating > 0 ? income.averageRating.toFixed(1) + ' ‚≠ê' : 'N/A' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Sales Details Table -->
  <div class="sales-section card" *ngIf="!isLoading && sales.length > 0">
    <div class="section-header" (click)="toggleOrderDetails()">
      <h2>üßæ Order Details ({{ sales.length }} orders)</h2>
      <span class="toggle-icon">{{ showOrderDetails ? '‚ñº' : '‚ñ∂' }}</span>
    </div>
    <div class="table-container" *ngIf="showOrderDetails">
      <div class="pagination-info">
        Showing {{ (currentPage - 1) * ordersPerPage + 1 }} - {{ Math.min(currentPage * ordersPerPage, sales.length) }} of {{ sales.length }} orders
      </div>
      <table class="sales-table">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Platform</th>
            <th>Order ID</th>
            <th>Customer</th>
            <th>Items</th>
            <th>Distance</th>
            <th>Bill Total</th>
            <th>Discount</th>
            <th>Packaging</th>
            <th>Income (Payout)</th>
            <th>Deduction (Track)</th>
            <th>Rating</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let sale of paginatedSales" [class.zomato-row]="sale.platform === 'Zomato'" [class.swiggy-row]="sale.platform === 'Swiggy'">
            <td class="date-cell">{{ formatDate(sale.orderAt) }}</td>
            <td>
              <span [class]="'platform-badge ' + sale.platform.toLowerCase()">
                {{ sale.platform }}
              </span>
            </td>
            <td class="order-id">{{ sale.orderId }}</td>
            <td>{{ sale.customerName || 'N/A' }}</td>
            <td>
              <span class="items-preview" [title]="formatOrderedItems(sale.orderedItems)">
                {{ getTotalItemsCount(sale.orderedItems) }} items
              </span>
            </td>
            <td class="text-center">{{ sale.distance }} km</td>
            <td class="amount">{{ formatCurrency(sale.billSubTotal) }}</td>
            <td class="amount discount-amount">{{ formatCurrency(sale.discountAmount || 0) }}</td>
            <td class="amount packaging-amount">{{ formatCurrency(sale.packagingCharges || 0) }}</td>
            <td class="amount income-highlight"><strong>{{ formatCurrency(sale.payout) }}</strong></td>
            <td class="amount track-only">{{ formatCurrency(sale.platformDeduction) }}</td>
            <td class="text-center">
              <span *ngIf="sale.rating" class="rating">{{ sale.rating }} ‚≠ê</span>
              <span *ngIf="!sale.rating" class="no-rating">N/A</span>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Pagination Controls -->
      <div class="pagination-controls" *ngIf="totalPages > 1">
        <button class="btn btn-pagination" (click)="previousPage()" [disabled]="currentPage === 1">
          ‚Üê Previous
        </button>
        <div class="page-numbers">
          <button
            *ngFor="let page of [].constructor(totalPages); let i = index"
            class="btn btn-page"
            [class.active]="currentPage === i + 1"
            (click)="goToPage(i + 1)"
            [style.display]="Math.abs(currentPage - (i + 1)) <= 2 || i === 0 || i === totalPages - 1 ? 'inline-block' : 'none'"
          >
            {{ i + 1 }}
          </button>
        </div>
        <button class="btn btn-pagination" (click)="nextPage()" [disabled]="currentPage === totalPages">
          Next ‚Üí
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && sales.length === 0" class="empty-state card">
    <div class="empty-icon">üì¶</div>
    <h3>No Sales Data Available</h3>
    <p>Upload an Excel file for {{ selectedPlatform }} to get started</p>
  </div>
</div>
